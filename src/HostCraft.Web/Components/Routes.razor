@rendermode InteractiveServer
@inject HttpClient Http
@implements IDisposable
@inject NavigationManager Navigation
@inject ILogger<Routes> Logger
@inject AuthenticationStateProvider AuthStateProvider
@inject IWebAuthService AuthService

@using HostCraft.Web.Models

<Router AppAssembly="typeof(Program).Assembly" NotFoundPage="typeof(Pages.NotFound)">
    <Found Context="routeData">
        @{
            // Handle redirects
            if (!IsCheckingSetup && SetupRequired && routeData.PageType != typeof(Pages.Setup))
            {
                Navigation.NavigateTo("/setup", forceLoad: false);
            }
            else if (!IsCheckingSetup && !SetupRequired && !IsPublicPage(routeData.PageType) && !IsCheckingAuth && !IsAuthenticated)
            {
                Navigation.NavigateTo("/login", forceLoad: false);
            }
        }

        @if (IsCheckingSetup)
        {
            <div class="setup-check-loading">
                <div class="spinner"></div>
                <p>Checking setup status...</p>
            </div>
        }
        else if (SetupRequired && routeData.PageType != typeof(Pages.Setup))
        {
            <div class="setup-check-loading">
                <div class="spinner"></div>
                <p>Redirecting to setup...</p>
            </div>
        }
        else if (IsPublicPage(routeData.PageType))
        {
            @* Public pages don't need auth check *@
            <RouteView RouteData="routeData" DefaultLayout="typeof(Layout.MainLayout)" />
            <FocusOnNavigate RouteData="routeData" Selector="h1" />
        }
        else if (IsCheckingAuth)
        {
            <div class="setup-check-loading">
                <div class="spinner"></div>
                <p>Checking authentication...</p>
            </div>
        }
        else if (!IsAuthenticated)
        {
            <div class="setup-check-loading">
                <div class="spinner"></div>
                <p>Redirecting to login...</p>
            </div>
        }
        else
        {
            <RouteView RouteData="routeData" DefaultLayout="typeof(Layout.MainLayout)" />
            <FocusOnNavigate RouteData="routeData" Selector="h1" />
        }
    </Found>
</Router>

@code {
    [CascadingParameter]
    public HttpContext? HttpContext { get; set; }

    private bool IsCheckingSetup = true;
    private bool SetupRequired = false;
    private bool IsAuthenticated = false;
    private bool IsCheckingAuth = true;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to authentication state changes
        AuthStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;

        // Check setup status during initialization (doesn't require JS)
        await CheckSetupStatus();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Logger.LogInformation("OnAfterRenderAsync - first render, checking auth");

            // Check authentication after first render when JS interop is available
            await CheckAuthenticationStatus();
            IsCheckingAuth = false;
            Logger.LogInformation("Auth check complete. IsAuthenticated={IsAuthenticated}", IsAuthenticated);
            StateHasChanged();
        }
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        var authState = await task;
        var wasAuthenticated = IsAuthenticated;
        IsAuthenticated = authState.User?.Identity?.IsAuthenticated == true;

        if (wasAuthenticated != IsAuthenticated)
        {
            Logger.LogInformation("Authentication state changed. IsAuthenticated: {IsAuthenticated}", IsAuthenticated);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task CheckSetupStatus()
    {
        try
        {
            var response = await Http.GetAsync("api/auth/setup-required");
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<SetupStatusResponse>();
                SetupRequired = result?.SetupRequired ?? true; // Default to setup required if null
                Logger.LogInformation("Setup status check: SetupRequired={SetupRequired}", SetupRequired);
            }
            else
            {
                Logger.LogWarning("Failed to check setup status: {StatusCode}, assuming setup required", response.StatusCode);
                SetupRequired = true; // Assume setup required if API fails
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking setup status, assuming setup required");
            SetupRequired = true; // Assume setup required on error
        }
        finally
        {
            IsCheckingSetup = false;
            StateHasChanged();
        }
    }

    private async Task CheckAuthenticationStatus()
    {
        try
        {
            Logger.LogInformation("Starting authentication check...");

            // Initialize authentication service
            await AuthService.InitializeAsync();
            Logger.LogInformation("AuthService.InitializeAsync completed");

            // Check if user is authenticated
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            IsAuthenticated = authState.User?.Identity?.IsAuthenticated == true;

            Logger.LogInformation("Authentication check completed. IsAuthenticated: {IsAuthenticated}", IsAuthenticated);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking authentication status");
            IsAuthenticated = false;
        }
    }

    private bool IsPublicPage(Type pageType)
    {
        // Define which pages are accessible without authentication
        var publicPages = new[]
        {
            typeof(Pages.Setup),
            typeof(Pages.Login),
            typeof(Pages.NotFound),
            typeof(Pages.Error)
        };

        return publicPages.Contains(pageType);
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }
}

<style>
.setup-check-loading {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #0a0e27 0%, #1a2344 50%, #141b3a 100%);
    color: white;
    z-index: 9999;
}

.setup-check-loading .spinner {
    width: 48px;
    height: 48px;
    border: 3px solid rgba(99, 102, 241, 0.2);
    border-top: 3px solid #6366f1;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

.setup-check-loading p {
    margin: 0;
    font-size: 1.1rem;
    color: #a0a0b8;
}

@@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
