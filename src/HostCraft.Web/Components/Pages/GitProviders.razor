@page "/settings/git-providers"
@rendermode InteractiveServer
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ILogger<GitProviders> Logger

<PageTitle>Git Providers - HostCraft</PageTitle>

<div class="page-container">
    <div class="page-header">
        <div>
            <h1>Git Providers</h1>
            <p class="page-subtitle">Connect your GitHub, GitLab, or Bitbucket accounts to deploy from repositories</p>
        </div>
        <a href="/settings" class="btn btn-outline">
            <span class="icon">‚Üê</span> Back to Settings
        </a>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success">
            <span class="icon">‚úì</span> @successMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            <span class="icon">‚úï</span> @errorMessage
        </div>
    }

    <!-- Connected Providers -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <span>üîó</span> Connected Accounts
            </h2>
        </div>
        <div class="card-body">
            @if (loading)
            {
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading providers...</p>
                </div>
            }
            else if (providers == null || !providers.Any())
            {
                <div class="empty-state">
                    <div class="empty-icon">üîå</div>
                    <h3>No Git Providers Connected</h3>
                    <p>Connect a Git provider below to start deploying from repositories</p>
                </div>
            }
            else
            {
                <div class="providers-list">
                    @foreach (var provider in providers)
                    {
                        <div class="provider-card">
                            <div class="provider-info">
                                <div class="provider-avatar">
                                    @if (!string.IsNullOrEmpty(provider.AvatarUrl))
                                    {
                                        <img src="@provider.AvatarUrl" alt="@provider.Username" />
                                    }
                                    else
                                    {
                                        <span class="provider-icon">@GetProviderIcon(provider.Type)</span>
                                    }
                                </div>
                                <div class="provider-details">
                                    <h3>@provider.Name</h3>
                                    <p class="provider-username">@@@provider.Username</p>
                                    <div class="provider-meta">
                                        <span class="provider-type-badge @provider.Type.ToString().ToLower()">
                                            @GetProviderIcon(provider.Type) @provider.Type
                                        </span>
                                        @if (provider.IsActive)
                                        {
                                            <span class="status-badge active">Active</span>
                                        }
                                        else
                                        {
                                            <span class="status-badge inactive">Inactive</span>
                                        }
                                    </div>
                                    <p class="connected-date">Connected @FormatDate(provider.ConnectedAt)</p>
                                </div>
                            </div>
                            <div class="provider-actions">
                                <button class="btn btn-outline btn-sm" @onclick="() => TestConnection(provider.Id)" disabled="@testingConnection">
                                    @if (testingProviderId == provider.Id)
                                    {
                                        <span class="spinner-sm"></span>
                                    }
                                    else
                                    {
                                        <span>üîç Test</span>
                                    }
                                </button>
                                <button class="btn btn-outline btn-sm" @onclick="() => ViewRepositories(provider.Id)">
                                    <span>üìÅ Repos</span>
                                </button>
                                <button class="btn btn-danger btn-sm" @onclick="() => DisconnectProvider(provider)" disabled="@disconnecting">
                                    <span>üóëÔ∏è</span>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Add New Provider -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <span>‚ûï</span> Connect New Provider
            </h2>
        </div>
        <div class="card-body">
            <div class="provider-options">
                <button class="provider-option" @onclick="() => ConnectProvider(GitProviderType.GitHub)" disabled="@connecting">
                    <div class="provider-option-icon github">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                        </svg>
                    </div>
                    <div class="provider-option-info">
                        <h3>GitHub</h3>
                        <p>Connect your GitHub account</p>
                    </div>
                    <span class="connect-arrow">‚Üí</span>
                </button>

                <button class="provider-option" @onclick="() => ConnectProvider(GitProviderType.GitLab)" disabled="@connecting">
                    <div class="provider-option-icon gitlab">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z"/>
                        </svg>
                    </div>
                    <div class="provider-option-info">
                        <h3>GitLab</h3>
                        <p>Connect your GitLab account</p>
                    </div>
                    <span class="connect-arrow">‚Üí</span>
                </button>

                <button class="provider-option" @onclick="() => ConnectProvider(GitProviderType.Bitbucket)" disabled="@connecting">
                    <div class="provider-option-icon bitbucket">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M.778 1.211a.768.768 0 00-.768.892l3.263 19.81c.084.5.515.868 1.022.873H19.95a.772.772 0 00.77-.646l3.27-20.03a.768.768 0 00-.768-.891zM14.52 15.53H9.522L8.17 8.466h7.561z"/>
                        </svg>
                    </div>
                    <div class="provider-option-info">
                        <h3>Bitbucket</h3>
                        <p>Connect your Bitbucket account</p>
                    </div>
                    <span class="connect-arrow">‚Üí</span>
                </button>

                <button class="provider-option" @onclick="() => ShowGiteaModal()" disabled="@connecting">
                    <div class="provider-option-icon gitea">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 17.703c-.357.18-.768.283-1.204.283-1.473 0-2.667-1.194-2.667-2.667 0-.436.103-.847.283-1.204L12 12l2.306-2.115c.357-.18.768-.283 1.204-.283 1.473 0 2.667 1.194 2.667 2.667 0 .436-.103.847-.283 1.204L15.588 16l.306 1.703zM12 14.667c-1.473 0-2.667-1.194-2.667-2.667S10.527 9.333 12 9.333 14.667 10.527 14.667 12 13.473 14.667 12 14.667z"/>
                        </svg>
                    </div>
                    <div class="provider-option-info">
                        <h3>Gitea</h3>
                        <p>Connect self-hosted Gitea</p>
                    </div>
                    <span class="connect-arrow">‚Üí</span>
                </button>
            </div>
        </div>
    </div>

    <!-- OAuth Configuration Section -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <span>üîê</span> OAuth Configuration
            </h2>
            <span class="badge">Required to connect providers</span>
        </div>
        <div class="card-body">
            @if (loadingSettings)
            {
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading settings...</p>
                </div>
            }
            else
            {
                <p class="settings-intro">Configure OAuth credentials for each Git provider you want to use. These are stored securely in the database.</p>

                <div class="oauth-settings-grid">
                    @foreach (var setting in providerSettings ?? new List<GitProviderSettingsDto>())
                    {
                        <div class="oauth-setting-card @(setting.IsConfigured && setting.IsEnabled ? "configured" : "")">
                            <div class="oauth-setting-header">
                                <span class="provider-icon-sm">@GetProviderIcon(setting.Type)</span>
                                <h4>@setting.Name</h4>
                                @if (setting.IsConfigured && setting.IsEnabled)
                                {
                                    <span class="status-dot active" title="Configured"></span>
                                }
                                else if (setting.IsConfigured)
                                {
                                    <span class="status-dot disabled" title="Disabled"></span>
                                }
                                else
                                {
                                    <span class="status-dot unconfigured" title="Not configured"></span>
                                }
                            </div>
                            <p class="oauth-status">
                                @if (setting.IsConfigured && setting.IsEnabled)
                                {
                                    <span class="text-success">‚úì Ready to use</span>
                                }
                                else if (setting.IsConfigured)
                                {
                                    <span class="text-warning">Disabled</span>
                                }
                                else
                                {
                                    <span class="text-muted">Not configured</span>
                                }
                            </p>
                            <button class="btn btn-outline btn-sm" @onclick="() => OpenConfigModal(setting.Type)">
                                @(setting.IsConfigured ? "Edit" : "Configure")
                            </button>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Help Section -->
    <div class="card">
        <div class="card-header collapsible" @onclick="() => showHelp = !showHelp">
            <h2 class="card-title">
                <span>‚ùì</span> Setup Help
            </h2>
            <span class="collapse-icon">@(showHelp ? "‚ñº" : "‚ñ∂")</span>
        </div>
        @if (showHelp)
        {
            <div class="card-body">
                <div class="help-content">
                    <h3>How to set up GitHub OAuth</h3>
                    <ol>
                        <li>Go to <a href="https://github.com/settings/developers" target="_blank">GitHub Developer Settings</a></li>
                        <li>Click "New OAuth App"</li>
                        <li>Set Application name: <code>HostCraft</code></li>
                        <li>Set Homepage URL: <code>@GetBaseUrl()</code></li>
                        <li>Set Authorization callback URL: <code>@GetBaseUrl()/api/gitproviders/callback</code></li>
                        <li>Click "Configure" above and enter your Client ID and Client Secret</li>
                    </ol>
                </div>
            </div>
        }
    </div>
</div>

@if (showGiteaModal)
{
    <div class="modal-backdrop" @onclick="CloseGiteaModal">
        <div class="modal-dialog" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Connect Gitea Instance</h3>
                <button class="btn-close" @onclick="CloseGiteaModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="giteaUrl">Gitea URL</label>
                    <input type="url" id="giteaUrl" @bind="giteaUrl" class="form-control" placeholder="https://gitea.example.com" />
                    <small>The base URL of your Gitea instance</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="CloseGiteaModal">Cancel</button>
                <button class="btn btn-primary" @onclick="ConnectGitea" disabled="@connecting">
                    @if (connecting)
                    {
                        <span class="spinner-sm"></span>
                    }
                    Connect
                </button>
            </div>
        </div>
    </div>
}

@if (showReposModal)
{
    <div class="modal-backdrop" @onclick="CloseReposModal">
        <div class="modal-dialog modal-lg" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Repositories</h3>
                <button class="btn-close" @onclick="CloseReposModal">√ó</button>
            </div>
            <div class="modal-body">
                @if (loadingRepos)
                {
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Loading repositories...</p>
                    </div>
                }
                else if (repositories == null || !repositories.Any())
                {
                    <div class="empty-state">
                        <p>No repositories found</p>
                    </div>
                }
                else
                {
                    <div class="repos-list">
                        @foreach (var repo in repositories)
                        {
                            <div class="repo-item">
                                <div class="repo-info">
                                    <h4>@repo.FullName</h4>
                                    @if (!string.IsNullOrEmpty(repo.Description))
                                    {
                                        <p class="repo-description">@repo.Description</p>
                                    }
                                    <div class="repo-meta">
                                        @if (repo.IsPrivate)
                                        {
                                            <span class="badge badge-warning">Private</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-info">Public</span>
                                        }
                                        <span class="repo-language">@repo.Language</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-sm" @onclick="() => CreateAppFromRepo(repo)">
                                    Deploy
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

@if (showConfigModal)
{
    <div class="modal-backdrop" @onclick="CloseConfigModal">
        <div class="modal-dialog" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Configure @editingProviderType OAuth</h3>
                <button class="btn-close" @onclick="CloseConfigModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="clientId">Client ID <span class="required">*</span></label>
                    <input type="text" id="clientId" @bind="configClientId" class="form-control"
                           placeholder="Enter your OAuth Client ID" />
                </div>
                <div class="form-group">
                    <label for="clientSecret">Client Secret <span class="required">*</span></label>
                    <input type="password" id="clientSecret" @bind="configClientSecret" class="form-control"
                           placeholder="@(string.IsNullOrEmpty(configClientSecretMasked) ? "Enter your OAuth Client Secret" : "Leave blank to keep existing")" />
                    @if (!string.IsNullOrEmpty(configClientSecretMasked))
                    {
                        <small class="form-hint">Current: @configClientSecretMasked</small>
                    }
                </div>
                @if (editingProviderType == GitProviderType.GitLab || editingProviderType == GitProviderType.Gitea)
                {
                    <div class="form-group">
                        <label for="apiUrl">API URL (for self-hosted)</label>
                        <input type="url" id="apiUrl" @bind="configApiUrl" class="form-control"
                               placeholder="https://gitlab.example.com" />
                        <small class="form-hint">Leave blank for @(editingProviderType).com</small>
                    </div>
                }
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="configEnabled" />
                        <span>Enable this provider</span>
                    </label>
                </div>

                <div class="help-box">
                    <h4>üìã Setup Instructions</h4>
                    @switch (editingProviderType)
                    {
                        case GitProviderType.GitHub:
                            <ol>
                                <li>Go to <a href="https://github.com/settings/developers" target="_blank">GitHub Developer Settings</a></li>
                                <li>Click "New OAuth App"</li>
                                <li>Set callback URL: <code>@GetBaseUrl()/api/gitproviders/callback</code></li>
                            </ol>
                            break;
                        case GitProviderType.GitLab:
                            <ol>
                                <li>Go to GitLab ‚Üí User Settings ‚Üí Applications</li>
                                <li>Create a new application</li>
                                <li>Set callback URL: <code>@GetBaseUrl()/api/gitproviders/callback</code></li>
                                <li>Enable scopes: <code>read_user, read_api, read_repository</code></li>
                            </ol>
                            break;
                        case GitProviderType.Bitbucket:
                            <ol>
                                <li>Go to Bitbucket ‚Üí Settings ‚Üí OAuth consumers</li>
                                <li>Add a new consumer</li>
                                <li>Set callback URL: <code>@GetBaseUrl()/api/gitproviders/callback</code></li>
                            </ol>
                            break;
                        default:
                            <p>Follow your Git provider's documentation to create an OAuth application.</p>
                            break;
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="CloseConfigModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveConfig" disabled="@savingConfig">
                    @if (savingConfig)
                    {
                        <span class="spinner-sm"></span>
                    }
                    Save Configuration
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<GitProviderDto>? providers;
    private List<GitProviderSettingsDto>? providerSettings;
    private bool loading = true;
    private bool loadingSettings = true;
    private bool connecting = false;
    private bool disconnecting = false;
    private bool testingConnection = false;
    private int? testingProviderId;
    private string? successMessage;
    private string? errorMessage;

    private bool showGiteaModal = false;
    private string? giteaUrl;

    private bool showReposModal = false;
    private bool loadingRepos = false;
    private List<GitRepositoryDto>? repositories;
    private int? selectedProviderId;

    private bool showHelp = false;

    // OAuth Config Modal
    private bool showConfigModal = false;
    private bool savingConfig = false;
    private GitProviderType editingProviderType;
    private string? configClientId;
    private string? configClientSecret;
    private string? configClientSecretMasked;
    private string? configApiUrl;
    private bool configEnabled = true;

    protected override async Task OnInitializedAsync()
    {
        // Check for callback parameters
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        if (query["connected"] != null)
        {
            successMessage = "Git provider connected successfully!";
        }
        else if (query["error"] != null)
        {
            errorMessage = Uri.UnescapeDataString(query["error"]!);
        }

        await Task.WhenAll(LoadProviders(), LoadProviderSettings());
    }

    private async Task LoadProviders()
    {
        loading = true;
        try
        {
            providers = await Http.GetFromJsonAsync<List<GitProviderDto>>("api/gitproviders");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load git providers");
            errorMessage = "Failed to load git providers";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadProviderSettings()
    {
        loadingSettings = true;
        try
        {
            providerSettings = await Http.GetFromJsonAsync<List<GitProviderSettingsDto>>("api/gitprovider-settings");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load provider settings");
        }
        finally
        {
            loadingSettings = false;
        }
    }

    private async Task OpenConfigModal(GitProviderType type)
    {
        editingProviderType = type;
        configClientId = null;
        configClientSecret = null;
        configClientSecretMasked = null;
        configApiUrl = null;
        configEnabled = true;

        try
        {
            var details = await Http.GetFromJsonAsync<GitProviderSettingsDetailDto>($"api/gitprovider-settings/{type}");
            if (details != null)
            {
                configClientId = details.ClientId;
                configClientSecretMasked = details.ClientSecretMasked;
                configApiUrl = details.ApiUrl;
                configEnabled = details.IsEnabled || !details.IsConfigured; // Default to enabled if new
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load settings for {Type}", type);
        }

        showConfigModal = true;
    }

    private void CloseConfigModal()
    {
        showConfigModal = false;
    }

    private async Task SaveConfig()
    {
        if (string.IsNullOrWhiteSpace(configClientId))
        {
            errorMessage = "Client ID is required";
            return;
        }

        // If no existing secret and no new secret provided
        if (string.IsNullOrEmpty(configClientSecretMasked) && string.IsNullOrWhiteSpace(configClientSecret))
        {
            errorMessage = "Client Secret is required";
            return;
        }

        savingConfig = true;
        errorMessage = null;

        try
        {
            var request = new SaveGitProviderSettingsRequest(
                editingProviderType,
                editingProviderType.ToString(),
                configClientId,
                configClientSecret,
                configApiUrl,
                configEnabled
            );

            var response = await Http.PostAsJsonAsync("api/gitprovider-settings", request);
            response.EnsureSuccessStatusCode();

            successMessage = $"{editingProviderType} OAuth configuration saved successfully!";
            showConfigModal = false;

            // Reload settings
            await LoadProviderSettings();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save config for {Type}", editingProviderType);
            errorMessage = $"Failed to save configuration: {ex.Message}";
        }
        finally
        {
            savingConfig = false;
        }
    }

    private async Task ConnectProvider(GitProviderType type)
    {
        connecting = true;
        errorMessage = null;

        try
        {
            var response = await Http.GetFromJsonAsync<AuthUrlResponse>($"api/gitproviders/auth-url?type={type}");

            if (response != null && !string.IsNullOrEmpty(response.AuthUrl))
            {
                Navigation.NavigateTo(response.AuthUrl, forceLoad: true);
            }
            else
            {
                errorMessage = "Failed to get authorization URL. Check if OAuth credentials are configured.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to connect {Type}", type);
            errorMessage = $"Failed to connect: {ex.Message}";
        }
        finally
        {
            connecting = false;
        }
    }

    private void ShowGiteaModal()
    {
        giteaUrl = null;
        showGiteaModal = true;
    }

    private void CloseGiteaModal()
    {
        showGiteaModal = false;
    }

    private async Task ConnectGitea()
    {
        if (string.IsNullOrWhiteSpace(giteaUrl))
        {
            errorMessage = "Please enter a Gitea URL";
            return;
        }

        connecting = true;
        errorMessage = null;

        try
        {
            var response = await Http.GetFromJsonAsync<AuthUrlResponse>($"api/gitproviders/auth-url?type=Gitea&apiUrl={Uri.EscapeDataString(giteaUrl)}");

            if (response != null && !string.IsNullOrEmpty(response.AuthUrl))
            {
                Navigation.NavigateTo(response.AuthUrl, forceLoad: true);
            }
            else
            {
                errorMessage = "Failed to get authorization URL";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to connect Gitea");
            errorMessage = $"Failed to connect: {ex.Message}";
        }
        finally
        {
            connecting = false;
            showGiteaModal = false;
        }
    }

    private async Task TestConnection(int providerId)
    {
        testingConnection = true;
        testingProviderId = providerId;
        errorMessage = null;
        successMessage = null;

        try
        {
            var response = await Http.PostAsync($"api/gitproviders/{providerId}/test", null);
            var result = await response.Content.ReadFromJsonAsync<TestConnectionResult>();

            if (result?.IsValid == true)
            {
                successMessage = "Connection test successful!";
            }
            else
            {
                errorMessage = result?.Message ?? "Connection test failed";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to test connection");
            errorMessage = $"Test failed: {ex.Message}";
        }
        finally
        {
            testingConnection = false;
            testingProviderId = null;
        }
    }

    private async Task DisconnectProvider(GitProviderDto provider)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm",
            $"Are you sure you want to disconnect {provider.Name}?\n\nThis will not affect existing deployments, but you won't be able to deploy new applications from this account.");

        if (!confirmed) return;

        disconnecting = true;
        errorMessage = null;

        try
        {
            var response = await Http.DeleteAsync($"api/gitproviders/{provider.Id}");

            if (response.IsSuccessStatusCode)
            {
                successMessage = $"Disconnected {provider.Name}";
                await LoadProviders();
            }
            else
            {
                errorMessage = "Failed to disconnect provider";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to disconnect provider");
            errorMessage = $"Failed to disconnect: {ex.Message}";
        }
        finally
        {
            disconnecting = false;
        }
    }

    private async Task ViewRepositories(int providerId)
    {
        selectedProviderId = providerId;
        showReposModal = true;
        loadingRepos = true;
        repositories = null;

        try
        {
            repositories = await Http.GetFromJsonAsync<List<GitRepositoryDto>>($"api/gitproviders/{providerId}/repositories");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load repositories");
            errorMessage = "Failed to load repositories";
        }
        finally
        {
            loadingRepos = false;
        }
    }

    private void CloseReposModal()
    {
        showReposModal = false;
        repositories = null;
        selectedProviderId = null;
    }

    private void CreateAppFromRepo(GitRepositoryDto repo)
    {
        // Navigate to application form with repo pre-filled
        Navigation.NavigateTo($"/applications/new?providerId={selectedProviderId}&repo={Uri.EscapeDataString(repo.FullName)}");
    }

    private string GetProviderIcon(GitProviderType type) => type switch
    {
        GitProviderType.GitHub => "üêô",
        GitProviderType.GitLab => "ü¶ä",
        GitProviderType.Bitbucket => "ü™£",
        GitProviderType.Gitea => "üçµ",
        _ => "üì¶"
    };

    private string FormatDate(DateTime date)
    {
        var span = DateTime.UtcNow - date;
        if (span.TotalDays < 1) return "today";
        if (span.TotalDays < 2) return "yesterday";
        if (span.TotalDays < 30) return $"{(int)span.TotalDays} days ago";
        return date.ToString("MMM dd, yyyy");
    }

    private string GetBaseUrl()
    {
        return $"{Navigation.BaseUri.TrimEnd('/')}";
    }

    // DTOs
    public class GitProviderDto
    {
        public int Id { get; set; }
        public GitProviderType Type { get; set; }
        public string Name { get; set; } = "";
        public string Username { get; set; } = "";
        public string? AvatarUrl { get; set; }
        public string? Email { get; set; }
        public DateTime ConnectedAt { get; set; }
        public bool IsActive { get; set; }
    }

    public class GitRepositoryDto
    {
        public string Name { get; set; } = "";
        public string FullName { get; set; } = "";
        public string? Description { get; set; }
        public string CloneUrl { get; set; } = "";
        public string? Language { get; set; }
        public bool IsPrivate { get; set; }
        public string DefaultBranch { get; set; } = "main";
    }

    public record AuthUrlResponse(string AuthUrl);

    public record TestConnectionResult
    {
        public bool IsValid { get; init; }
        public string Message { get; init; } = "";
    }

    public enum GitProviderType
    {
        GitHub,
        GitLab,
        Bitbucket,
        Gitea
    }

    // Settings DTOs
    public class GitProviderSettingsDto
    {
        public int Id { get; set; }
        public GitProviderType Type { get; set; }
        public string Name { get; set; } = "";
        public bool IsConfigured { get; set; }
        public bool IsEnabled { get; set; }
        public string? ApiUrl { get; set; }
    }

    public class GitProviderSettingsDetailDto
    {
        public int Id { get; set; }
        public GitProviderType Type { get; set; }
        public string Name { get; set; } = "";
        public string? ClientId { get; set; }
        public string? ClientSecretMasked { get; set; }
        public string? ApiUrl { get; set; }
        public bool IsEnabled { get; set; }
        public bool IsConfigured { get; set; }
    }

    public record SaveGitProviderSettingsRequest(
        GitProviderType Type,
        string? Name,
        string ClientId,
        string? ClientSecret,
        string? ApiUrl,
        bool IsEnabled);
}

<style>
    .page-container {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
        margin: 0;
    }

    .page-subtitle {
        color: #94a3b8;
        margin-top: 0.5rem;
    }

    .card {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid #334155;
        border-radius: 1rem;
        margin-bottom: 1.5rem;
    }

    .card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #334155;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .card-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #fff;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    .providers-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .provider-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 0.75rem;
        transition: all 0.2s;
    }

    .provider-card:hover {
        border-color: #6366f1;
    }

    .provider-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .provider-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: #334155;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .provider-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .provider-icon {
        font-size: 1.5rem;
    }

    .provider-details h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
        margin: 0;
    }

    .provider-username {
        color: #94a3b8;
        font-size: 0.875rem;
        margin: 0.25rem 0;
    }

    .provider-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .provider-type-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .provider-type-badge.github {
        background: #1f2937;
        color: #e2e8f0;
    }

    .provider-type-badge.gitlab {
        background: #7c3aed20;
        color: #a78bfa;
    }

    .provider-type-badge.bitbucket {
        background: #2563eb20;
        color: #60a5fa;
    }

    .provider-type-badge.gitea {
        background: #10b98120;
        color: #6ee7b7;
    }

    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-badge.active {
        background: #10b98120;
        color: #10b981;
    }

    .status-badge.inactive {
        background: #f59e0b20;
        color: #f59e0b;
    }

    .connected-date {
        color: #64748b;
        font-size: 0.75rem;
        margin: 0.5rem 0 0 0;
    }

    .provider-actions {
        display: flex;
        gap: 0.5rem;
    }

    .provider-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .provider-option {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.25rem;
        background: #0f172a;
        border: 2px solid #334155;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        width: 100%;
    }

    .provider-option:hover:not(:disabled) {
        border-color: #6366f1;
        transform: translateY(-2px);
    }

    .provider-option:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .provider-option-icon {
        width: 48px;
        height: 48px;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .provider-option-icon.github {
        background: #1f2937;
        color: #e2e8f0;
    }

    .provider-option-icon.gitlab {
        background: #7c3aed20;
        color: #f97316;
    }

    .provider-option-icon.bitbucket {
        background: #2563eb20;
        color: #2563eb;
    }

    .provider-option-icon.gitea {
        background: #10b98120;
        color: #10b981;
    }

    .provider-option-info {
        flex: 1;
    }

    .provider-option-info h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
        margin: 0;
    }

    .provider-option-info p {
        color: #94a3b8;
        font-size: 0.875rem;
        margin: 0.25rem 0 0 0;
    }

    .connect-arrow {
        color: #6366f1;
        font-size: 1.25rem;
    }

    .help-content {
        color: #cbd5e1;
    }

    .help-content h3 {
        color: #fff;
        margin-top: 0;
    }

    .help-content ol {
        padding-left: 1.25rem;
        line-height: 1.8;
    }

    .help-content code {
        background: #0f172a;
        padding: 0.125rem 0.5rem;
        border-radius: 0.25rem;
        font-family: monospace;
        color: #a78bfa;
    }

    .config-example {
        margin-top: 1.5rem;
        padding: 1rem;
        background: #0f172a;
        border-radius: 0.5rem;
    }

    .config-example h4 {
        color: #fff;
        margin: 0 0 1rem 0;
        font-size: 0.875rem;
    }

    .config-example pre {
        margin: 0;
        overflow-x: auto;
    }

    .config-example code {
        background: transparent;
        padding: 0;
        color: #10b981;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #94a3b8;
    }

    .empty-icon {
        font-size: 3rem;
        opacity: 0.5;
        margin-bottom: 1rem;
    }

    .empty-state h3 {
        color: #fff;
        margin: 0 0 0.5rem 0;
    }

    .loading-state {
        text-align: center;
        padding: 2rem;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #334155;
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    .spinner-sm {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #334155;
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .alert {
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .alert-success {
        background: #10b98120;
        border: 1px solid #10b981;
        color: #10b981;
    }

    .alert-danger {
        background: #ef444420;
        border: 1px solid #ef4444;
        color: #ef4444;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: #fff;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid #334155;
        color: #e2e8f0;
    }

    .btn-outline:hover {
        border-color: #6366f1;
        background: #6366f120;
    }

    .btn-danger {
        background: #ef444420;
        border: 1px solid #ef4444;
        color: #ef4444;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-dialog {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 1rem;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-lg {
        max-width: 800px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #334155;
    }

    .modal-header h3 {
        margin: 0;
        color: #fff;
    }

    .btn-close {
        background: none;
        border: none;
        color: #94a3b8;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        border-top: 1px solid #334155;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #e2e8f0;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        color: #e2e8f0;
    }

    .form-control:focus {
        outline: none;
        border-color: #6366f1;
    }

    .form-group small {
        display: block;
        margin-top: 0.5rem;
        color: #64748b;
        font-size: 0.875rem;
    }

    .repos-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .repo-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 0.5rem;
    }

    .repo-info h4 {
        color: #fff;
        margin: 0;
        font-size: 0.95rem;
    }

    .repo-description {
        color: #94a3b8;
        font-size: 0.875rem;
        margin: 0.25rem 0;
    }

    .repo-meta {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .badge {
        padding: 0.125rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }

    .badge-warning {
        background: #f59e0b20;
        color: #f59e0b;
    }

    .badge-info {
        background: #3b82f620;
        color: #3b82f6;
    }

    .repo-language {
        color: #64748b;
        font-size: 0.75rem;
    }

    /* OAuth Settings Grid */
    .settings-intro {
        color: #94a3b8;
        margin-bottom: 1.5rem;
    }

    .oauth-settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }

    .oauth-setting-card {
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 0.75rem;
        padding: 1rem;
        transition: all 0.2s;
    }

    .oauth-setting-card.configured {
        border-color: #10b981;
    }

    .oauth-setting-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .provider-icon-sm {
        font-size: 1.25rem;
    }

    .oauth-setting-header h4 {
        flex: 1;
        margin: 0;
        font-size: 1rem;
        color: #fff;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-dot.active {
        background: #10b981;
    }

    .status-dot.disabled {
        background: #f59e0b;
    }

    .status-dot.unconfigured {
        background: #64748b;
    }

    .oauth-status {
        font-size: 0.75rem;
        margin: 0.5rem 0 1rem 0;
    }

    .text-success {
        color: #10b981;
    }

    .text-warning {
        color: #f59e0b;
    }

    .text-muted {
        color: #64748b;
    }

    /* Help Box in Modal */
    .help-box {
        background: #0f172a;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 1rem;
    }

    .help-box h4 {
        margin: 0 0 0.75rem 0;
        color: #fff;
        font-size: 0.875rem;
    }

    .help-box ol {
        margin: 0;
        padding-left: 1.25rem;
        color: #94a3b8;
        font-size: 0.875rem;
        line-height: 1.6;
    }

    .help-box code {
        background: #1e293b;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        color: #a78bfa;
        font-size: 0.75rem;
    }

    /* Required asterisk */
    .required {
        color: #ef4444;
    }

    /* Checkbox label */
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
        width: 1rem;
        height: 1rem;
        accent-color: #6366f1;
    }

    /* Collapsible card header */
    .card-header.collapsible {
        cursor: pointer;
        user-select: none;
    }

    .card-header.collapsible:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .collapse-icon {
        margin-left: auto;
        color: #64748b;
        font-size: 0.75rem;
    }
</style>
