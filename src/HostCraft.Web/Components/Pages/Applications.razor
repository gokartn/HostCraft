@page "/applications"
@rendermode InteractiveServer
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ILogger<Applications> Logger

<div class="page-container">
    <div class="page-header">
        <div class="header-left">
            <h1>üöÄ Applications</h1>
            <p class="subtitle">Deploy and manage your applications</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" @onclick="RefreshApplications">
                üîÑ Refresh
            </button>
            <button class="btn btn-primary" @onclick="NavigateToCreate">
                ‚ûï New Application
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading applications...</p>
        </div>
    }
    else if (applications == null || !applications.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <h2>No Applications</h2>
            <p>Deploy your first application to get started</p>
            <button class="btn btn-primary" @onclick="NavigateToCreate">
                ‚ûï Deploy Application
            </button>
        </div>
    }
    else
    {
        <div class="apps-grid">
            @foreach (var app in applications)
            {
                <div class="app-card @GetStatusClass(app.Status)">
                    <div class="app-header">
                        <div class="app-name">
                            <h3>@app.Name</h3>
                            @if (!string.IsNullOrEmpty(app.Description))
                            {
                                <span class="app-description">@app.Description</span>
                            }
                        </div>
                        <span class="status-badge @GetStatusClass(app.Status)">
                            @GetStatusIcon(app.Status)
                        </span>
                    </div>
                    
                    <div class="app-info">
                        <div class="info-item">
                            <span class="label">Image</span>
                            <span class="value">@app.DockerImage</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Server</span>
                            <span class="value">@app.ServerName</span>
                        </div>
                        @if (!string.IsNullOrEmpty(app.ServiceId))
                        {
                            <div class="info-item">
                                <span class="label">Mode</span>
                                <span class="value">üêù Swarm Service</span>
                            </div>
                            @if (app.SwarmReplicas.HasValue)
                            {
                                <div class="info-item">
                                    <span class="label">Replicas</span>
                                    <span class="value">@app.RunningReplicas/@app.SwarmReplicas</span>
                                </div>
                            }
                        }
                        else if (!string.IsNullOrEmpty(app.ContainerId))
                        {
                            <div class="info-item">
                                <span class="label">Mode</span>
                                <span class="value">üì¶ Container</span>
                            </div>
                        }
                        @if (app.LastDeployedAt.HasValue)
                        {
                            <div class="info-item">
                                <span class="label">Deployed</span>
                                <span class="value">@app.LastDeployedAt.Value.ToString("MM/dd HH:mm")</span>
                            </div>
                        }
                    </div>
                    
                    <div class="app-actions">
                        <button class="btn-icon" @onclick="() => ViewDetails(app.Id)" title="View Details">
                            üëÅÔ∏è
                        </button>
                        @if (!string.IsNullOrEmpty(app.ContainerId) || !string.IsNullOrEmpty(app.ServiceId))
                        {
                            <button class="btn-icon" @onclick="() => ViewLogs(app.Id)" title="Logs">
                                üìÑ
                            </button>
                        }
                        @if (!string.IsNullOrEmpty(app.ServiceId) && app.SwarmReplicas.HasValue)
                        {
                            <button class="btn-icon" @onclick="() => ScaleDown(app.Id)" title="Scale Down" disabled="@(app.SwarmReplicas <= 1)">
                                ‚ûñ
                            </button>
                            <button class="btn-icon" @onclick="() => ScaleUp(app.Id)" title="Scale Up">
                                ‚ûï
                            </button>
                        }
                        <button class="btn-icon btn-primary" @onclick="() => Redeploy(app.Id)" title="Redeploy">
                            üîÑ
                        </button>
                        <button class="btn-icon btn-danger" @onclick="() => DeleteApplication(app.Id)" title="Delete">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<ApplicationDto>? applications;
    private bool isLoading = true;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadApplications();
    }
    
    private async Task LoadApplications()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            applications = await Http.GetFromJsonAsync<List<ApplicationDto>>("api/applications");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading applications");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task RefreshApplications()
    {
        await LoadApplications();
    }
    
    private void NavigateToCreate()
    {
        Navigation.NavigateTo("/applications/new");
    }
    
    private void ViewDetails(int appId)
    {
        Navigation.NavigateTo($"/applications/{appId}");
    }
    
    private void ViewLogs(int appId)
    {
        Navigation.NavigateTo($"/applications/{appId}/logs");
    }
    
    private async Task Redeploy(int appId)
    {
        try
        {
            var response = await Http.PostAsync($"api/applications/{appId}/deploy", null);
            if (response.IsSuccessStatusCode)
            {
                await LoadApplications();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error redeploying application");
        }
    }
    
    private async Task DeleteApplication(int appId)
    {
        try
        {
            var response = await Http.DeleteAsync($"api/applications/{appId}");
            if (response.IsSuccessStatusCode)
            {
                await LoadApplications();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting application");
        }
    }
    
    private async Task ScaleUp(int appId)
    {
        try
        {
            var app = applications?.FirstOrDefault(a => a.Id == appId);
            if (app != null)
            {
                var newReplicas = (app.SwarmReplicas ?? 1) + 1;
                var response = await Http.PostAsync($"api/applications/{appId}/scale?replicas={newReplicas}", null);
                if (response.IsSuccessStatusCode)
                {
                    await LoadApplications();
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error scaling up application");
        }
    }
    
    private async Task ScaleDown(int appId)
    {
        try
        {
            var app = applications?.FirstOrDefault(a => a.Id == appId);
            if (app != null && app.SwarmReplicas > 1)
            {
                var newReplicas = app.SwarmReplicas.Value - 1;
                var response = await Http.PostAsync($"api/applications/{appId}/scale?replicas={newReplicas}", null);
                if (response.IsSuccessStatusCode)
                {
                    await LoadApplications();
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error scaling down application");
        }
    }
    
    private string GetStatusClass(DeploymentStatus status) => status switch
    {
        DeploymentStatus.Running => "status-running",
        DeploymentStatus.Success => "status-success",
        DeploymentStatus.Failed => "status-failed",
        DeploymentStatus.Queued => "status-queued",
        DeploymentStatus.Cancelled => "status-cancelled",
        _ => "status-unknown"
    };
    
    private string GetStatusIcon(DeploymentStatus status) => status switch
    {
        DeploymentStatus.Running => "üîÑ",
        DeploymentStatus.Success => "‚úÖ",
        DeploymentStatus.Failed => "‚ùå",
        DeploymentStatus.Queued => "‚è≥",
        DeploymentStatus.Cancelled => "üö´",
        _ => "‚ö™"
    };
    
    private record ApplicationDto(
        int Id,
        string Name,
        string? Description,
        int ServerId,
        string ServerName,
        int ProjectId,
        string ProjectName,
        string? DockerImage,
        DeploymentStatus Status,
        string? ContainerId,
        string? ServiceId,
        DateTime? LastDeployedAt,
        DateTime CreatedAt,
        int? SwarmReplicas,
        int? RunningReplicas
    );
}

<style>
    .page-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .header-left h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
        margin: 0;
    }

    .subtitle {
        color: #94a3b8;
        font-size: 0.95rem;
        margin-top: 0.5rem;
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
    }

    .btn {
        padding: 0.5rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.95rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: #fff;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
    }

    .btn-secondary {
        background: #334155;
        color: #fff;
    }

    .btn-secondary:hover {
        background: #475569;
    }

    .loading-spinner, .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 1rem;
        border: 1px solid #334155;
    }

    .spinner {
        border: 3px solid #334155;
        border-top-color: #6366f1;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state h2 {
        color: #fff;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #94a3b8;
        margin-bottom: 1.5rem;
    }

    .apps-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 1.5rem;
    }

    .app-card {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 2px solid #334155;
        border-radius: 1rem;
        padding: 1.5rem;
        transition: all 0.3s;
    }

    .app-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    .app-card.status-running {
        border-color: #3b82f6;
    }

    .app-card.status-success {
        border-color: #10b981;
    }

    .app-card.status-failed {
        border-color: #ef4444;
        background: linear-gradient(135deg, #1e293b 0%, #2a1215 100%);
    }

    .app-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #334155;
    }

    .app-name h3 {
        color: #fff;
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }

    .app-description {
        color: #94a3b8;
        font-size: 0.85rem;
        margin-top: 0.25rem;
        display: block;
    }

    .status-badge {
        padding: 0.4rem 0.9rem;
        border-radius: 0.5rem;
        font-size: 1.2rem;
    }

    .status-badge.status-running {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
    }

    .status-badge.status-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
    }

    .status-badge.status-failed {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
    }

    .app-info {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
    }

    .info-item .label {
        color: #94a3b8;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .info-item .value {
        color: #fff;
        font-size: 0.9rem;
        text-align: right;
        word-break: break-all;
    }

    .app-actions {
        display: flex;
        gap: 0.5rem;
        padding-top: 1rem;
        border-top: 1px solid #334155;
        flex-wrap: wrap;
    }

    .btn-icon {
        width: 42px;
        height: 42px;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        border: 1px solid #334155;
        background: #1e293b;
        color: #fff;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-icon:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .btn-icon:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .btn-icon.btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-color: #6366f1;
    }

    .btn-icon.btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-color: #ef4444;
    }

    @@media (max-width: 768px) {
        .page-container {
            padding: 1rem;
        }

        .page-header {
            flex-direction: column;
            align-items: stretch;
        }

        .apps-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
