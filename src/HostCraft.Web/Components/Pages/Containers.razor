@page "/servers/{ServerId:int}/containers"
@rendermode InteractiveServer
@using System.Net.Http.Json
@using Microsoft.JSInterop
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ILogger<Containers> Logger

<div class="page-container">
    <div class="page-header">
        <div class="header-left">
            <h1>üê≥ Containers</h1>
            <p class="subtitle">@(server?.Name ?? "Loading...")</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" @onclick="RefreshContainers">
                üîÑ Refresh
            </button>
            <button class="btn btn-primary" @onclick="ShowCreateDialog">
                ‚ûï Create Container
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading containers...</p>
        </div>
    }
    else if (containers == null || !containers.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <h2>No Containers</h2>
            <p>Create your first container to get started</p>
            <button class="btn btn-primary" @onclick="ShowCreateDialog">
                ‚ûï Create Container
            </button>
        </div>
    }
    else
    {
        <div class="container-grid">
            @foreach (var container in containers)
            {
                <div class="container-card @GetStatusClass(container.State)">
                    <div class="container-header">
                        <div class="container-name">
                            <h3>@container.Name</h3>
                            <span class="container-id">@container.Id.Substring(0, 12)</span>
                        </div>
                        <span class="status-badge @GetStatusClass(container.State)">
                            @GetStatusIcon(container.State) @container.State
                        </span>
                    </div>
                    
                    <div class="container-info">
                        <div class="info-row">
                            <span class="label">Image:</span>
                            <span class="value">@container.Image</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Created:</span>
                            <span class="value">@container.Created.ToString("g")</span>
                        </div>
                        @if (container.Ports?.Any() == true)
                        {
                            <div class="info-row">
                                <span class="label">Ports:</span>
                                <span class="value">@string.Join(", ", container.Ports)</span>
                            </div>
                        }
                    </div>
                    
                    <div class="container-actions">
                        @if (container.State == "running")
                        {
                            <button class="btn-icon btn-warning" @onclick="() => StopContainer(container.Id)" title="Stop">
                                ‚è∏Ô∏è
                            </button>
                            <button class="btn-icon" @onclick="() => RestartContainer(container.Id)" title="Restart">
                                üîÑ
                            </button>
                        }
                        else
                        {
                            <button class="btn-icon btn-success" @onclick="() => StartContainer(container.Id)" title="Start">
                                ‚ñ∂Ô∏è
                            </button>
                        }
                        <button class="btn-icon" @onclick="() => ViewLogs(container.Id)" title="Logs">
                            üìÑ
                        </button>
                        <button class="btn-icon btn-danger" @onclick="() => DeleteContainer(container.Id)" title="Delete">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public int ServerId { get; set; }
    
    private ServerResponseDto? server;
    private List<ContainerDto>? containers;
    private bool isLoading = true;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadServer();
        await LoadContainers();
    }
    
    private async Task LoadServer()
    {
        try
        {
            server = await Http.GetFromJsonAsync<ServerResponseDto>($"api/servers/{ServerId}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading server");
        }
    }
    
    private async Task LoadContainers()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            containers = await Http.GetFromJsonAsync<List<ContainerDto>>($"api/servers/{ServerId}/containers");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading containers");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task RefreshContainers()
    {
        await LoadContainers();
    }
    
    private void ShowCreateDialog()
    {
        // TODO: Implement create dialog
        Logger.LogInformation("Create container dialog - to be implemented");
    }
    
    private async Task StartContainer(string containerId)
    {
        try
        {
            var response = await Http.PostAsync($"api/servers/{ServerId}/containers/{containerId}/start", null);
            if (response.IsSuccessStatusCode)
            {
                await LoadContainers();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error starting container");
        }
    }
    
    private async Task StopContainer(string containerId)
    {
        try
        {
            var response = await Http.PostAsync($"api/servers/{ServerId}/containers/{containerId}/stop", null);
            if (response.IsSuccessStatusCode)
            {
                await LoadContainers();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error stopping container");
        }
    }
    
    private async Task RestartContainer(string containerId)
    {
        try
        {
            var response = await Http.PostAsync($"api/servers/{ServerId}/containers/{containerId}/restart", null);
            if (response.IsSuccessStatusCode)
            {
                await LoadContainers();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error restarting container");
        }
    }
    
    private async Task DeleteContainer(string containerId)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this container?"))
            return;
            
        try
        {
            var response = await Http.DeleteAsync($"api/servers/{ServerId}/containers/{containerId}");
            if (response.IsSuccessStatusCode)
            {
                await LoadContainers();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting container");
        }
    }
    
    private void ViewLogs(string containerId)
    {
        Navigation.NavigateTo($"/servers/{ServerId}/containers/{containerId}/logs");
    }
    
    private string GetStatusClass(string state) => state.ToLower() switch
    {
        "running" => "status-running",
        "exited" => "status-stopped",
        "paused" => "status-paused",
        "restarting" => "status-restarting",
        _ => "status-unknown"
    };
    
    private string GetStatusIcon(string state) => state.ToLower() switch
    {
        "running" => "üü¢",
        "exited" => "üî¥",
        "paused" => "üü°",
        "restarting" => "üîÑ",
        _ => "‚ö™"
    };
    
    private record ContainerDto(string Id, string Name, string Image, string State, DateTime Created, List<string>? Ports);
    private record ServerResponseDto(int Id, string Name, string Host, int Port, string User, bool IsSwarm, string Status);
}
