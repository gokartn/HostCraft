@page "/"
@using HostCraft.Core.Enums
@inject HttpClient Http

<PageTitle>HostCraft Dashboard</PageTitle>

<div class="dashboard-header">
    <h1>HostCraft Dashboard</h1>
    <p class="subtitle">Self-Hosted PaaS Platform</p>
</div>

<div class="deployment-status-grid">
    @if (servers == null)
    {
        <div class="loading-card">
            <div class="spinner"></div>
            <p>Loading deployment information...</p>
        </div>
    }
    else if (!servers.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">🚀</div>
            <h2>Welcome to HostCraft!</h2>
            <p>No servers configured yet. Add your first server to get started.</p>
            <a href="/servers/new" class="btn btn-primary">Add Server</a>
        </div>
    }
    else
    {
        <!-- Deployment Type Overview -->
        <div class="deployment-overview">
            @if (swarmServers.Any())
            {
                <DeploymentTypeCard 
                    Type="Docker Swarm"
                    Icon="🐝"
                    Color="primary"
                    ServerCount="@swarmServers.Count"
                    Status="@GetSwarmStatus()"
                    Description="@GetSwarmDescription()" />
            }
            
            @if (standaloneServers.Any())
            {
                <DeploymentTypeCard 
                    Type="Standalone"
                    Icon="🐳"
                    Color="info"
                    ServerCount="@standaloneServers.Count"
                    Status="online"
                    Description="Single-server Docker deployments" />
            }
            
            @if (kubernetesServers.Any())
            {
                <DeploymentTypeCard 
                    Type="Kubernetes"
                    Icon="☸️"
                    Color="success"
                    ServerCount="@kubernetesServers.Count"
                    Status="coming-soon"
                    Description="Kubernetes cluster support (planned)" />
            }
        </div>

        <!-- Detailed Server List -->
        <div class="servers-section">
            <h2>Infrastructure</h2>
            
            @if (swarmServers.Any())
            {
                <div class="server-group">
                    <h3>
                        <span class="badge badge-swarm">🐝 DOCKER SWARM CLUSTER</span>
                        <span class="cluster-health">@GetSwarmClusterHealth()</span>
                    </h3>
                    
                    <div class="swarm-topology">
                        @foreach (var manager in swarmServers.Where(s => s.Type == ServerType.SwarmManager))
                        {
                            <ServerCard Server="@(new ServerCard.ServerDto { Id = manager.Id, Name = manager.Name, Host = manager.Host, Type = manager.Type, Status = manager.Status, IsSwarm = manager.IsSwarm })" Role="Manager" />
                        }
                        
                        @foreach (var worker in swarmServers.Where(s => s.Type == ServerType.SwarmWorker))
                        {
                            <ServerCard Server="@(new ServerCard.ServerDto { Id = worker.Id, Name = worker.Name, Host = worker.Host, Type = worker.Type, Status = worker.Status, IsSwarm = worker.IsSwarm })" Role="Worker" />
                        }
                    </div>
                    
                    <div class="swarm-stats">
                        <div class="stat">
                            <span class="stat-value">@swarmServers.Count(s => s.Type == ServerType.SwarmManager)</span>
                            <span class="stat-label">Managers</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">@swarmServers.Count(s => s.Type == ServerType.SwarmWorker)</span>
                            <span class="stat-label">Workers</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">@GetQuorumStatus()</span>
                            <span class="stat-label">Quorum</span>
                        </div>
                    </div>
                </div>
            }
            
            @if (standaloneServers.Any())
            {
                <div class="server-group">
                    <h3>
                        <span class="badge badge-standalone">🐳 STANDALONE SERVERS</span>
                    </h3>
                    <div class="standalone-list">
                        @foreach (var server in standaloneServers)
                        {
                            <ServerCard Server="@(new ServerCard.ServerDto { Id = server.Id, Name = server.Name, Host = server.Host, Type = server.Type, Status = server.Status, IsSwarm = server.IsSwarm })" Role="Standalone" />
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .dashboard-header {
        margin-bottom: 32px;
    }

    .dashboard-header h1 {
        margin: 0;
        font-size: 36px;
        font-weight: 700;
        color: #2c3e50;
    }

    .subtitle {
        color: #6c757d;
        font-size: 16px;
        margin-top: 8px;
    }

    .deployment-status-grid {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .deployment-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .empty-state {
        text-align: center;
        padding: 80px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .empty-icon {
        font-size: 80px;
        margin-bottom: 20px;
    }

    .empty-state h2 {
        color: #2c3e50;
        margin-bottom: 12px;
    }

    .empty-state p {
        color: #6c757d;
        margin-bottom: 24px;
    }

    .btn-primary {
        display: inline-block;
        padding: 12px 32px;
        background: #0066cc;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
        transition: background 0.2s;
    }

    .btn-primary:hover {
        background: #0052a3;
    }

    .servers-section {
        background: #f8f9fa;
        padding: 24px;
        border-radius: 12px;
    }

    .servers-section > h2 {
        margin: 0 0 24px 0;
        font-size: 24px;
        color: #2c3e50;
    }

    .server-group {
        margin-bottom: 32px;
    }

    .server-group:last-child {
        margin-bottom: 0;
    }

    .server-group > h3 {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }

    .badge {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    .badge-swarm {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .badge-standalone {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }

    .cluster-health {
        font-size: 14px;
        font-weight: 600;
        padding: 8px 16px;
        border-radius: 6px;
        background: white;
    }

    .swarm-topology {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .standalone-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
    }

    .swarm-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        border: 2px solid #e9ecef;
    }

    .stat {
        text-align: center;
    }

    .stat-value {
        display: block;
        font-size: 32px;
        font-weight: 700;
        color: #0066cc;
        line-height: 1;
        margin-bottom: 8px;
    }

    .stat-label {
        display: block;
        font-size: 13px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .loading-card {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 12px;
    }

    .spinner {
        width: 50px;
        height: 50px;
        margin: 0 auto 20px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0066cc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

@code {
    private List<ServerDto>? servers;
    private List<ServerDto> swarmServers => servers?.Where(s => s.IsSwarm).ToList() ?? new();
    private List<ServerDto> standaloneServers => servers?.Where(s => !s.IsSwarm).ToList() ?? new();
    private List<ServerDto> kubernetesServers => new(); // Placeholder for future K8s support

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // TODO: Call actual API endpoint when ready
            // servers = await Http.GetFromJsonAsync<List<ServerDto>>("/api/servers");
            
            // Mock data for demonstration - shows your actual 3-node Swarm cluster
            servers = new List<ServerDto>
            {
                new ServerDto 
                { 
                    Id = 1, 
                    Name = "housio-Hetzner", 
                    Host = "10.0.1.10",
                    Type = ServerType.SwarmManager, 
                    Status = ServerStatus.Online,
                    Region = "eu-west-1 (Hetzner)",
                    SwarmManagerCount = 3,
                    SwarmWorkerCount = 2
                },
                new ServerDto 
                { 
                    Id = 2, 
                    Name = "housio-home", 
                    Host = "10.0.1.11",
                    Type = ServerType.SwarmWorker, 
                    Status = ServerStatus.Online,
                    Region = "eu-west-1 (Home)"
                },
                new ServerDto 
                { 
                    Id = 3, 
                    Name = "housio-worker-node", 
                    Host = "10.0.1.12",
                    Type = ServerType.SwarmWorker, 
                    Status = ServerStatus.Online,
                    Region = "eu-west-1"
                }
            };
        }
        catch (Exception ex)
        {
            servers = new List<ServerDto>();
        }
    }

    private string GetSwarmStatus()
    {
        var managers = swarmServers.Count(s => s.Type == ServerType.SwarmManager);
        var onlineManagers = swarmServers.Count(s => s.Type == ServerType.SwarmManager && s.Status == ServerStatus.Online);
        
        if (managers >= 3 && onlineManagers >= (managers / 2) + 1)
            return "healthy";
        if (onlineManagers >= (managers / 2) + 1)
            return "degraded";
        return "critical";
    }

    private string GetSwarmDescription()
    {
        var managers = swarmServers.Count(s => s.Type == ServerType.SwarmManager);
        var workers = swarmServers.Count(s => s.Type == ServerType.SwarmWorker);
        return $"{managers} manager{(managers != 1 ? "s" : "")}, {workers} worker{(workers != 1 ? "s" : "")} - High availability enabled";
    }

    private string GetSwarmClusterHealth()
    {
        var status = GetSwarmStatus();
        return status switch
        {
            "healthy" => "✅ HEALTHY - Quorum Maintained",
            "degraded" => "⚠️ DEGRADED - Reduced Redundancy",
            "critical" => "🔴 CRITICAL - Quorum Lost",
            _ => "❓ UNKNOWN"
        };
    }

    private string GetQuorumStatus()
    {
        var managers = swarmServers.Count(s => s.Type == ServerType.SwarmManager);
        var required = (managers / 2) + 1;
        return $"{required}/{managers}";
    }

    // DTOs (temporary - should be in Shared project later)
    public class ServerDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Host { get; set; } = "";
        public ServerType Type { get; set; }
        public ServerStatus Status { get; set; }
        public string? Region { get; set; }
        public int? SwarmManagerCount { get; set; }
        public int? SwarmWorkerCount { get; set; }
        public bool IsSwarm => Type == ServerType.SwarmManager || Type == ServerType.SwarmWorker;
    }
}
