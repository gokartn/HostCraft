@page "/swarm/nodes"
@page "/swarm/nodes/{serverId:int}"
@rendermode InteractiveServer

@using System.Net.Http.Json
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject ILogger<SwarmNodes> Logger

<PageTitle>Swarm Nodes - HostCraft</PageTitle>

<div class="swarm-nodes-page">
    <div class="page-header">
        <div>
            <h1>Swarm Nodes</h1>
            <p class="subtitle">Manage your Docker Swarm cluster nodes</p>
        </div>
        <div style="display: flex; gap: 0.75rem; align-items: center;">
            @if (servers != null && servers.Any(s => s.IsSwarmManager))
            {
                <select class="form-select" style="width: auto;" @onchange="OnServerSelected" value="@selectedServerId">
                    <option value="0">Select Server...</option>
                    @foreach (var server in servers.Where(s => s.IsSwarmManager))
                    {
                        <option value="@server.Id">@server.Name</option>
                    }
                </select>
            }
            <button class="btn btn-secondary" @onclick="RefreshNodes" disabled="@(selectedServerId == 0)">
                <span class="icon">üîÑ</span> Refresh
            </button>
            @if (nodes != null && nodes.Any(n => n.State == "down"))
            {
                <button class="btn btn-warning" @onclick="CleanupStaleNodes" disabled="@(selectedServerId == 0)">
                    <span class="icon">üßπ</span> Clean Up Stale Nodes
                </button>
            }
            <button class="btn btn-primary" @onclick="ShowJoinTokens" disabled="@(selectedServerId == 0)">
                <span class="icon">‚ûï</span> Add Node
            </button>
        </div>
    </div>

    @if (selectedServerId == 0)
    {
        <div class="empty-state">
            <div class="empty-icon">‚ö°</div>
            @if (servers == null || !servers.Any())
            {
                <h2>No Servers Configured</h2>
                <p>Add a server first to manage Docker Swarm nodes</p>
                <button class="btn btn-primary btn-lg" @onclick="ConfigureLocalhost">
                    <span class="icon">üñ•Ô∏è</span> Configure Localhost
                </button>
            }
            else if (!servers.Any(s => s.IsSwarmManager))
            {
                <h2>No Swarm Managers Found</h2>
                <p>None of your servers appear to be Docker Swarm managers</p>
                <button class="btn btn-primary btn-lg" @onclick="DetectSwarmManagers">
                    <span class="icon">üîç</span> Detect Swarm Managers
                </button>
            }
            else
            {
                <h2>No Swarm Manager Selected</h2>
                <p>Select a swarm manager server from the dropdown above to view and manage nodes</p>
            }
        </div>
    }
    else if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading nodes...</p>
        </div>
    }
    else if (!isSwarmActive)
    {
        <div class="empty-state">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <h2>Swarm Not Active</h2>
            <p>Docker Swarm is not initialized on this server</p>
            <button class="btn btn-primary btn-lg" @onclick="InitializeSwarm">
                <span class="icon">üêù</span> Initialize Swarm
            </button>
        </div>
    }
    else if (nodes == null || !nodes.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">‚ö°</div>
            <h2>No Nodes Found</h2>
            <p>No swarm nodes detected on this server</p>
            <button class="btn btn-primary btn-lg" @onclick="RefreshNodes">
                <span class="icon">üîÑ</span> Refresh
            </button>
        </div>
    }
    else
    {
        <div class="swarm-summary">
            <div class="summary-card">
                <div class="card-icon manager">üëë</div>
                <div class="card-content">
                    <span class="card-value">@nodes.Count(n => n.Role == "manager")</span>
                    <span class="card-label">Managers</span>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-icon worker">‚öôÔ∏è</div>
                <div class="card-content">
                    <span class="card-value">@nodes.Count(n => n.Role == "worker")</span>
                    <span class="card-label">Workers</span>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-icon ready">‚úÖ</div>
                <div class="card-content">
                    <span class="card-value">@nodes.Count(n => n.State == "ready")</span>
                    <span class="card-label">Ready</span>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-icon active">üü¢</div>
                <div class="card-content">
                    <span class="card-value">@nodes.Count(n => n.Availability == "active")</span>
                    <span class="card-label">Active</span>
                </div>
            </div>
        </div>

        <div class="nodes-grid">
            @foreach (var node in nodes)
            {
                <div class="node-card @GetNodeStatusClass(node)">
                    <div class="node-header">
                        <div class="node-title">
                            <h3>@node.Hostname</h3>
                            @if (node.IsLeader)
                            {
                                <span class="leader-badge">üëë Leader</span>
                            }
                        </div>
                        <span class="role-badge @node.Role">@node.Role</span>
                    </div>
                    
                    <div class="node-info">
                        <div class="info-row">
                            <span class="label">ID:</span>
                            <span class="value mono">@node.Id.Substring(0, 12)</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Status:</span>
                            <span class="value status-@node.State">@node.State</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Availability:</span>
                            <span class="value availability-@node.Availability">@node.Availability</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Address:</span>
                            <span class="value">@node.Address</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Platform:</span>
                            <span class="value">@node.Platform</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Engine:</span>
                            <span class="value">@node.EngineVersion</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Resources:</span>
                            <span class="value">@FormatCPU(node.NanoCPUs) CPUs, @FormatMemory(node.MemoryBytes) RAM</span>
                        </div>
                    </div>
                    
                    <div class="node-actions">
                        @if (node.Availability == "active")
                        {
                            <button class="btn-icon btn-warning" @onclick="() => DrainNode(node.Id)" title="Drain Node">
                                ‚è∏Ô∏è
                            </button>
                        }
                        else if (node.Availability == "drain")
                        {
                            <button class="btn-icon btn-success" @onclick="() => ActivateNode(node.Id)" title="Activate Node">
                                ‚ñ∂Ô∏è
                            </button>
                        }
                        
                        @if (node.Role == "worker" && node.State == "ready")
                        {
                            <button class="btn-icon btn-primary" @onclick="() => PromoteNode(node.Id)" title="Promote to Manager">
                                ‚¨ÜÔ∏è
                            </button>
                        }
                        else if (node.Role == "manager" && !node.IsLeader)
                        {
                            <button class="btn-icon" @onclick="() => DemoteNode(node.Id)" title="Demote to Worker">
                                ‚¨áÔ∏è
                            </button>
                        }
                        
                        @if (!node.IsLeader)
                        {
                            @if (node.State == "down")
                            {
                                <button class="btn-icon btn-danger" @onclick="() => RemoveNode(node.Id)" title="Remove Stale Node">
                                    üóëÔ∏è Remove
                                </button>
                            }
                            else if (node.State != "ready")
                            {
                                <button class="btn-icon btn-danger" @onclick="() => RemoveNode(node.Id)" title="Remove Node">
                                    üóëÔ∏è
                                </button>
                            }
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (showJoinTokensModal)
{
    <div class="modal-overlay" @onclick="CloseJoinTokens">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Add Nodes to Swarm</h2>
                <button class="btn-close" @onclick="CloseJoinTokens">‚úñ</button>
            </div>
            <div class="modal-body">
                @if (joinTokens != null)
                {
                    <div class="join-command-section">
                        <h3>üë§ Add Worker Node</h3>
                        <p>Run this command on the server you want to add as a worker:</p>
                        <div class="command-box">
                            <code>@workerJoinCommand</code>
                            <button class="btn-copy" @onclick="() => CopyToClipboard(workerJoinCommand)" title="Copy">
                                üìã
                            </button>
                        </div>
                    </div>
                    
                    <div class="join-command-section">
                        <h3>üëë Add Manager Node</h3>
                        <p>Run this command on the server you want to add as a manager:</p>
                        <div class="command-box">
                            <code>@managerJoinCommand</code>
                            <button class="btn-copy" @onclick="() => CopyToClipboard(managerJoinCommand)" title="Copy">
                                üìã
                            </button>
                        </div>
                    </div>
                    
                    @if (copiedMessage != null)
                    {
                        <div class="success-message">@copiedMessage</div>
                    }
                }
                else
                {
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Loading join tokens...</p>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int ServerId { get; set; }
    
    private List<ServerDto>? servers;
    private List<NodeDto>? nodes;
    private int selectedServerId = 0;
    private bool isLoading = false;
    private bool isSwarmActive = false;
    
    private HttpClient CreateHttpClient() => HttpClientFactory.CreateClient("HostCraftAPI");
    private bool showJoinTokensModal = false;
    private JoinTokensDto? joinTokens;
    private string? workerJoinCommand;
    private string? managerJoinCommand;
    private string? copiedMessage;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadServers();
        
        // If no servers exist, try to configure localhost
        if (servers == null || !servers.Any())
        {
            Logger.LogInformation("No servers found, attempting to configure localhost");
            await ConfigureLocalhost();
            await LoadServers(); // Reload after configuration
        }
        
        // If no swarm managers detected yet, try to detect them now
        if (servers != null && servers.Any() && !servers.Any(s => s.IsSwarmManager))
        {
            Logger.LogInformation("No swarm managers found, attempting to detect swarm on all servers");
            await DetectSwarmManagersInternal();
            await LoadServers(); // Reload after detection
        }
        
        if (ServerId > 0)
        {
            selectedServerId = ServerId;
            await LoadNodes();
        }
        else if (servers?.Any(s => s.IsSwarmManager) == true)
        {
            // Auto-select first swarm manager if none specified
            var firstManager = servers.First(s => s.IsSwarmManager);
            selectedServerId = firstManager.Id;
            await LoadNodes();
        }
    }
    
    private async Task ConfigureLocalhost()
    {
        try
        {
            Logger.LogInformation("Configuring localhost server");
            var response = await CreateHttpClient().PostAsync("api/servers/configure-localhost", null);
            if (response.IsSuccessStatusCode)
            {
                Logger.LogInformation("Localhost configured successfully");
                await LoadServers();
                
                // After configuring localhost, detect swarm if we have servers now
                if (servers != null && servers.Any() && !servers.Any(s => s.IsSwarmManager))
                {
                    await DetectSwarmManagersInternal();
                    await LoadServers();
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Logger.LogError("Failed to configure localhost: {Error}", error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error configuring localhost");
        }
    }
    
    private async Task DetectSwarmManagers()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            await DetectSwarmManagersInternal();
            await LoadServers();
            
            // Auto-select first manager if found
            if (servers?.Any(s => s.IsSwarmManager) == true)
            {
                var firstManager = servers.First(s => s.IsSwarmManager);
                selectedServerId = firstManager.Id;
                await LoadNodes();
            }
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task DetectSwarmManagersInternal()
    {
        if (servers == null || !servers.Any()) return;
        
        // Try to refresh swarm status for all servers
        var tasks = servers.Select(async server =>
        {
            try
            {
                Logger.LogInformation("Checking swarm status for server {ServerName} (ID: {ServerId})", server.Name, server.Id);
                var response = await CreateHttpClient().PostAsync($"api/servers/{server.Id}/refresh-swarm-status", null);
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadAsStringAsync();
                    Logger.LogInformation("Swarm detection result for {ServerName}: {Result}", server.Name, result);
                }
                else
                {
                    Logger.LogWarning("Failed to check swarm for {ServerName}: {StatusCode}", server.Name, response.StatusCode);
                }
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Error detecting swarm for server {ServerName}", server.Name);
            }
        });
        
        await Task.WhenAll(tasks);
    }
    
    private async Task LoadServers()
    {
        try
        {
            servers = await CreateHttpClient().GetFromJsonAsync<List<ServerDto>>("api/servers");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading servers");
        }
    }
    
    private async Task OnServerSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var serverId))
        {
            selectedServerId = serverId;
            if (serverId > 0)
            {
                await LoadNodes();
            }
        }
    }
    
    private async Task LoadNodes()
    {
        if (selectedServerId == 0) return;
        
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // First, refresh the server's swarm status to ensure it's up to date
            try
            {
                await CreateHttpClient().PostAsync($"api/servers/{selectedServerId}/refresh-swarm-status", null);
            }
            catch (Exception refreshEx)
            {
                Logger.LogWarning(refreshEx, "Could not refresh swarm status");
            }
            
            // Check if swarm is active
            var systemInfo = await CreateHttpClient().GetFromJsonAsync<SystemInfoDto>($"api/servers/{selectedServerId}/info");
            isSwarmActive = systemInfo?.SwarmActive ?? false;
            
            if (isSwarmActive)
            {
                nodes = await CreateHttpClient().GetFromJsonAsync<List<NodeDto>>($"api/servers/{selectedServerId}/nodes");
                
                // Reload servers list to update IsSwarmManager property
                await LoadServers();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading nodes");
            isSwarmActive = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task RefreshNodes()
    {
        await LoadNodes();
    }
    
    private async Task InitializeSwarm()
    {
        try
        {
            var response = await CreateHttpClient().PostAsync($"api/servers/{selectedServerId}/swarm/init", null);
            if (response.IsSuccessStatusCode)
            {
                await LoadNodes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing swarm");
        }
    }
    
    private async Task DrainNode(string nodeId)
    {
        try
        {
            var response = await CreateHttpClient().PutAsJsonAsync($"api/servers/{selectedServerId}/nodes/{nodeId}", 
                new { Availability = "drain" });
            if (response.IsSuccessStatusCode)
            {
                await LoadNodes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error draining node");
        }
    }
    
    private async Task ActivateNode(string nodeId)
    {
        try
        {
            var response = await CreateHttpClient().PutAsJsonAsync($"api/servers/{selectedServerId}/nodes/{nodeId}", 
                new { Availability = "active" });
            if (response.IsSuccessStatusCode)
            {
                await LoadNodes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error activating node");
        }
    }
    
    private async Task PromoteNode(string nodeId)
    {
        try
        {
            var response = await CreateHttpClient().PutAsJsonAsync($"api/servers/{selectedServerId}/nodes/{nodeId}", 
                new { Role = "manager" });
            if (response.IsSuccessStatusCode)
            {
                await LoadNodes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error promoting node");
        }
    }
    
    private async Task DemoteNode(string nodeId)
    {
        try
        {
            var response = await CreateHttpClient().PutAsJsonAsync($"api/servers/{selectedServerId}/nodes/{nodeId}", 
                new { Role = "worker" });
            if (response.IsSuccessStatusCode)
            {
                await LoadNodes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error demoting node");
        }
    }
    
    private async Task RemoveNode(string nodeId)
    {
        try
        {
            var response = await CreateHttpClient().DeleteAsync($"api/servers/{selectedServerId}/nodes/{nodeId}?force=true");
            if (response.IsSuccessStatusCode)
            {
                await LoadNodes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error removing node");
        }
    }
    
    private async Task CleanupStaleNodes()
    {
        if (nodes == null) return;
        
        try
        {
            Logger.LogInformation("Cleaning up stale nodes (down state)");
            var staleNodes = nodes.Where(n => n.State == "down" && !n.IsLeader).ToList();
            
            foreach (var node in staleNodes)
            {
                Logger.LogInformation("Removing stale node {NodeId} - {NodeHostname}", node.Id, node.Hostname);
                var response = await CreateHttpClient().DeleteAsync($"api/servers/{selectedServerId}/nodes/{node.Id}?force=true");
                if (!response.IsSuccessStatusCode)
                {
                    Logger.LogWarning("Failed to remove node {NodeId}", node.Id);
                }
            }
            
            await LoadNodes();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cleaning up stale nodes");
        }
    }
    
    private async Task ShowJoinTokens()
    {
        showJoinTokensModal = true;
        copiedMessage = null;
        
        try
        {
            joinTokens = await CreateHttpClient().GetFromJsonAsync<JoinTokensDto>($"api/servers/{selectedServerId}/swarm/tokens");
            
            if (joinTokens != null)
            {
                var server = servers?.FirstOrDefault(s => s.Id == selectedServerId);
                var managerAddress = server != null ? $"{server.Host}:2377" : "MANAGER_IP:2377";
                
                workerJoinCommand = $"docker swarm join --token {joinTokens.WorkerToken} {managerAddress}";
                managerJoinCommand = $"docker swarm join --token {joinTokens.ManagerToken} {managerAddress}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading join tokens");
        }
        
        StateHasChanged();
    }
    
    private void CloseJoinTokens()
    {
        showJoinTokensModal = false;
        joinTokens = null;
        copiedMessage = null;
    }
    
    private async Task CopyToClipboard(string text)
    {
        // In a real implementation, this would use JavaScript interop to copy to clipboard
        copiedMessage = "‚úÖ Copied to clipboard!";
        StateHasChanged();
        
        await Task.Delay(2000);
        copiedMessage = null;
        StateHasChanged();
    }
    
    private string GetNodeStatusClass(NodeDto node)
    {
        if (node.State != "ready") return "node-down";
        if (node.Availability == "drain") return "node-drain";
        return "node-ready";
    }
    
    private string FormatCPU(long nanoCPUs) => $"{nanoCPUs / 1_000_000_000.0:F2}";
    private string FormatMemory(long bytes) => $"{bytes / 1024.0 / 1024.0 / 1024.0:F2} GB";
    
    public class ServerDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Host { get; set; } = "";
        public HostCraft.Core.Enums.ServerType Type { get; set; }
        public bool IsSwarmManager { get; set; }
    }
    
    private record NodeDto(string Id, string Hostname, string Role, string State, string Availability, 
        bool IsLeader, string Address, long NanoCPUs, long MemoryBytes, string EngineVersion, string Platform);
    private record SystemInfoDto(bool SwarmActive);
    private record JoinTokensDto(string WorkerToken, string ManagerToken);
}

<style>
    .swarm-nodes-page {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
        margin: 0;
    }

    .subtitle {
        color: #94a3b8;
        font-size: 0.95rem;
        margin-top: 0.5rem;
    }

    .form-select {
        background: #1e293b;
        border: 1px solid #334155;
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.95rem;
        min-width: 200px;
        transition: all 0.2s;
    }

    .form-select:hover {
        border-color: #6366f1;
    }

    .form-select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .btn {
        padding: 0.5rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.95rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
    }

    .btn-secondary {
        background: #334155;
        color: #fff;
    }

    .btn-secondary:hover:not(:disabled) {
        background: #475569;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 1rem;
        border: 1px solid #334155;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state h2 {
        color: #fff;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #94a3b8;
        margin-bottom: 1.5rem;
    }

    .loading-state {
        text-align: center;
        padding: 4rem 2rem;
    }

    .spinner {
        border: 3px solid #334155;
        border-top-color: #6366f1;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .swarm-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .summary-card {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid #334155;
        border-radius: 1rem;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s;
    }

    .summary-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border-color: #6366f1;
    }

    .card-icon {
        font-size: 2.5rem;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.75rem;
        flex-shrink: 0;
    }

    .card-icon.manager { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .card-icon.worker { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .card-icon.ready { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .card-icon.active { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }

    .card-content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .card-value {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
        line-height: 1;
    }

    .card-label {
        color: #94a3b8;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .nodes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 1.5rem;
    }

    .node-card {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 2px solid #334155;
        border-radius: 1rem;
        padding: 1.5rem;
        transition: all 0.3s;
    }

    .node-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    .node-card.node-ready {
        border-color: #10b981;
    }

    .node-card.node-drain {
        border-color: #f59e0b;
        background: linear-gradient(135deg, #1e293b 0%, #292213 100%);
    }

    .node-card.node-down {
        border-color: #ef4444;
        background: linear-gradient(135deg, #1e293b 0%, #2a1215 100%);
    }

    .node-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #334155;
    }

    .node-title {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .node-title h3 {
        color: #fff;
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }

    .leader-badge {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: #fff;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
        box-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);
    }

    .role-badge {
        padding: 0.4rem 0.9rem;
        border-radius: 0.5rem;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .role-badge.manager {
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        color: #fff;
        box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
    }

    .role-badge.worker {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: #fff;
        box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
    }

    .node-info {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
    }

    .info-row .label {
        color: #94a3b8;
        font-size: 0.85rem;
        font-weight: 500;
        min-width: 100px;
    }

    .info-row .value {
        color: #fff;
        font-size: 0.9rem;
        text-align: right;
        word-break: break-all;
    }

    .info-row .value.mono {
        font-family: 'Courier New', monospace;
        background: #0f172a;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.85rem;
    }

    .info-row .value.status-ready {
        color: #10b981;
        font-weight: 600;
    }

    .info-row .value.status-down {
        color: #ef4444;
        font-weight: 600;
    }

    .info-row .value.availability-active {
        color: #06b6d4;
        font-weight: 600;
    }

    .info-row .value.availability-drain {
        color: #f59e0b;
        font-weight: 600;
    }

    .node-actions {
        display: flex;
        gap: 0.5rem;
        padding-top: 1rem;
        border-top: 1px solid #334155;
    }

    .btn-icon {
        width: 42px;
        height: 42px;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        border: 1px solid #334155;
        background: #1e293b;
        color: #fff;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .btn-icon.btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-color: #6366f1;
    }

    .btn-icon.btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: #10b981;
    }

    .btn-icon.btn-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        border-color: #f59e0b;
    }

    .btn-icon.btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-color: #ef4444;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
    }

    .modal-content {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid #334155;
        border-radius: 1rem;
        max-width: 700px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #334155;
    }

    .modal-header h2 {
        color: #fff;
        font-size: 1.5rem;
        margin: 0;
    }

    .btn-close {
        background: transparent;
        border: none;
        color: #94a3b8;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.25rem;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        transition: all 0.2s;
    }

    .btn-close:hover {
        background: #334155;
        color: #fff;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .join-command-section {
        margin-bottom: 2rem;
    }

    .join-command-section:last-child {
        margin-bottom: 0;
    }

    .join-command-section h3 {
        color: #fff;
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
    }

    .join-command-section p {
        color: #94a3b8;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .command-box {
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        position: relative;
    }

    .command-box code {
        flex: 1;
        color: #06b6d4;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        word-break: break-all;
        line-height: 1.5;
    }

    .btn-copy {
        background: #334155;
        border: none;
        color: #fff;
        padding: 0.5rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 1.2rem;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s;
    }

    .btn-copy:hover {
        background: #475569;
        transform: scale(1.1);
    }

    .success-message {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #fff;
        padding: 1rem;
        border-radius: 0.5rem;
        text-align: center;
        margin-top: 1rem;
        font-weight: 500;
    }

    .loading-spinner {
        text-align: center;
        padding: 2rem;
    }

    .loading-spinner p {
        color: #94a3b8;
        margin-top: 1rem;
    }

    @@media (max-width: 768px) {
        .swarm-nodes-page {
            padding: 1rem;
        }

        .page-header {
            flex-direction: column;
            align-items: stretch;
        }

        .nodes-grid {
            grid-template-columns: 1fr;
        }

        .summary-card {
            padding: 1rem;
        }

        .card-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
        }

        .card-value {
            font-size: 1.5rem;
        }
    }
</style>
