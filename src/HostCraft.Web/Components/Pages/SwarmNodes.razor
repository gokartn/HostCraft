@page "/swarm/nodes"
@page "/swarm/nodes/{serverId:int}"
@rendermode InteractiveServer

@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ILogger<SwarmNodes> Logger

<PageTitle>Swarm Nodes - HostCraft</PageTitle>

<div class="swarm-nodes-page">
    <div class="page-header">
        <div>
            <h1>Swarm Nodes</h1>
            <p class="subtitle">Manage your Docker Swarm cluster nodes</p>
        </div>
        <div style="display: flex; gap: 0.75rem; align-items: center;">
            @if (servers != null && servers.Any(s => s.IsSwarmManager))
            {
                <select class="form-select" style="width: auto;" @onchange="OnServerSelected" value="@selectedServerId">
                    <option value="0">Select Server...</option>
                    @foreach (var server in servers.Where(s => s.IsSwarmManager))
                    {
                        <option value="@server.Id">@server.Name</option>
                    }
                </select>
            }
            <button class="btn btn-secondary" @onclick="RefreshNodes" disabled="@(selectedServerId == 0)">
                <span class="icon">üîÑ</span> Refresh
            </button>
            <button class="btn btn-primary" @onclick="ShowJoinTokens" disabled="@(selectedServerId == 0)">
                <span class="icon">‚ûï</span> Add Node
            </button>
        </div>
    </div>

    @if (selectedServerId == 0)
    {
        <div class="empty-state">
            <div class="empty-icon">‚ö°</div>
            <h2>No Swarm Manager Selected</h2>
            <p>Select a swarm manager server from the dropdown above to view and manage nodes</p>
        </div>
    }
    else if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading nodes...</p>
        </div>
    }
    else if (!isSwarmActive)
    {
        <div class="empty-state">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <h2>Swarm Not Active</h2>
            <p>Docker Swarm is not initialized on this server</p>
            <button class="btn btn-primary btn-lg" @onclick="InitializeSwarm">
                <span class="icon">üêù</span> Initialize Swarm
            </button>
        </div>
    }
    else if (nodes == null || !nodes.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">‚ö°</div>
            <h2>No Nodes Found</h2>
            <p>No swarm nodes detected on this server</p>
            <button class="btn btn-primary btn-lg" @onclick="RefreshNodes">
                <span class="icon">üîÑ</span> Refresh
            </button>
        </div>
    }
    else
    {
        <div class="swarm-summary">
            <div class="summary-card">
                <div class="card-icon manager">üëë</div>
                <div class="card-content">
                    <span class="card-value">@nodes.Count(n => n.Role == "manager")</span>
                    <span class="card-label">Managers</span>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-icon worker">‚öôÔ∏è</div>
                <div class="card-content">
                    <span class="card-value">@nodes.Count(n => n.Role == "worker")</span>
                    <span class="card-label">Workers</span>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-icon ready">‚úÖ</div>
                <div class="card-content">
                    <span class="card-value">@nodes.Count(n => n.State == "ready")</span>
                    <span class="card-label">Ready</span>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-icon active">üü¢</div>
                <div class="card-content">
                    <span class="card-value">@nodes.Count(n => n.Availability == "active")</span>
                    <span class="card-label">Active</span>
                </div>
            </div>
        </div>

        <div class="nodes-grid">
            @foreach (var node in nodes)
            {
                <div class="node-card @GetNodeStatusClass(node)">
                    <div class="node-header">
                        <div class="node-title">
                            <h3>@node.Hostname</h3>
                            @if (node.IsLeader)
                            {
                                <span class="leader-badge">üëë Leader</span>
                            }
                        </div>
                        <span class="role-badge @node.Role">@node.Role</span>
                    </div>
                    
                    <div class="node-info">
                        <div class="info-row">
                            <span class="label">ID:</span>
                            <span class="value mono">@node.Id.Substring(0, 12)</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Status:</span>
                            <span class="value status-@node.State">@node.State</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Availability:</span>
                            <span class="value availability-@node.Availability">@node.Availability</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Address:</span>
                            <span class="value">@node.Address</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Platform:</span>
                            <span class="value">@node.Platform</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Engine:</span>
                            <span class="value">@node.EngineVersion</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Resources:</span>
                            <span class="value">@FormatCPU(node.NanoCPUs) CPUs, @FormatMemory(node.MemoryBytes) RAM</span>
                        </div>
                    </div>
                    
                    <div class="node-actions">
                        @if (node.Availability == "active")
                        {
                            <button class="btn-icon btn-warning" @onclick="() => DrainNode(node.Id)" title="Drain Node">
                                ‚è∏Ô∏è
                            </button>
                        }
                        else if (node.Availability == "drain")
                        {
                            <button class="btn-icon btn-success" @onclick="() => ActivateNode(node.Id)" title="Activate Node">
                                ‚ñ∂Ô∏è
                            </button>
                        }
                        
                        @if (node.Role == "worker" && node.State == "ready")
                        {
                            <button class="btn-icon btn-primary" @onclick="() => PromoteNode(node.Id)" title="Promote to Manager">
                                ‚¨ÜÔ∏è
                            </button>
                        }
                        else if (node.Role == "manager" && !node.IsLeader)
                        {
                            <button class="btn-icon" @onclick="() => DemoteNode(node.Id)" title="Demote to Worker">
                                ‚¨áÔ∏è
                            </button>
                        }
                        
                        @if (node.State != "ready" && !node.IsLeader)
                        {
                            <button class="btn-icon btn-danger" @onclick="() => RemoveNode(node.Id)" title="Remove Node">
                                üóëÔ∏è
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (showJoinTokensModal)
{
    <div class="modal-overlay" @onclick="CloseJoinTokens">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Add Nodes to Swarm</h2>
                <button class="btn-close" @onclick="CloseJoinTokens">‚úñ</button>
            </div>
            <div class="modal-body">
                @if (joinTokens != null)
                {
                    <div class="join-command-section">
                        <h3>üë§ Add Worker Node</h3>
                        <p>Run this command on the server you want to add as a worker:</p>
                        <div class="command-box">
                            <code>@workerJoinCommand</code>
                            <button class="btn-copy" @onclick="() => CopyToClipboard(workerJoinCommand)" title="Copy">
                                üìã
                            </button>
                        </div>
                    </div>
                    
                    <div class="join-command-section">
                        <h3>üëë Add Manager Node</h3>
                        <p>Run this command on the server you want to add as a manager:</p>
                        <div class="command-box">
                            <code>@managerJoinCommand</code>
                            <button class="btn-copy" @onclick="() => CopyToClipboard(managerJoinCommand)" title="Copy">
                                üìã
                            </button>
                        </div>
                    </div>
                    
                    @if (copiedMessage != null)
                    {
                        <div class="success-message">@copiedMessage</div>
                    }
                }
                else
                {
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Loading join tokens...</p>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int ServerId { get; set; }
    
    private List<ServerDto>? servers;
    private List<NodeDto>? nodes;
    private int selectedServerId = 0;
    private bool isLoading = false;
    private bool isSwarmActive = false;
    private bool showJoinTokensModal = false;
    private JoinTokensDto? joinTokens;
    private string? workerJoinCommand;
    private string? managerJoinCommand;
    private string? copiedMessage;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadServers();
        
        // If no swarm managers detected yet, try to detect them now
        if (servers != null && !servers.Any(s => s.IsSwarmManager))
        {
            Logger.LogInformation("No swarm managers found, attempting to detect swarm on all servers");
            await DetectSwarmManagers();
            await LoadServers(); // Reload after detection
        }
        
        if (ServerId > 0)
        {
            selectedServerId = ServerId;
            await LoadNodes();
        }
        else if (servers?.Any(s => s.IsSwarmManager) == true)
        {
            // Auto-select first swarm manager if none specified
            var firstManager = servers.First(s => s.IsSwarmManager);
            selectedServerId = firstManager.Id;
            await LoadNodes();
        }
    }
    
    private async Task DetectSwarmManagers()
    {
        if (servers == null) return;
        
        // Try to refresh swarm status for all servers
        var tasks = servers.Select(async server =>
        {
            try
            {
                Logger.LogInformation("Checking swarm status for server {ServerName} (ID: {ServerId})", server.Name, server.Id);
                var response = await Http.PostAsync($"api/servers/{server.Id}/refresh-swarm-status", null);
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadAsStringAsync();
                    Logger.LogInformation("Swarm detection result for {ServerName}: {Result}", server.Name, result);
                }
                else
                {
                    Logger.LogWarning("Failed to check swarm for {ServerName}: {StatusCode}", server.Name, response.StatusCode);
                }
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Error detecting swarm for server {ServerName}", server.Name);
            }
        });
        
        await Task.WhenAll(tasks);
    }
    
    private async Task LoadServers()
    {
        try
        {
            servers = await Http.GetFromJsonAsync<List<ServerDto>>("api/servers");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading servers");
        }
    }
    
    private async Task OnServerSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var serverId))
        {
            selectedServerId = serverId;
            if (serverId > 0)
            {
                await LoadNodes();
            }
        }
    }
    
    private async Task LoadNodes()
    {
        if (selectedServerId == 0) return;
        
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // First, refresh the server's swarm status to ensure it's up to date
            try
            {
                await Http.PostAsync($"api/servers/{selectedServerId}/refresh-swarm-status", null);
            }
            catch (Exception refreshEx)
            {
                Logger.LogWarning(refreshEx, "Could not refresh swarm status");
            }
            
            // Check if swarm is active
            var systemInfo = await Http.GetFromJsonAsync<SystemInfoDto>($"api/servers/{selectedServerId}/info");
            isSwarmActive = systemInfo?.SwarmActive ?? false;
            
            if (isSwarmActive)
            {
                nodes = await Http.GetFromJsonAsync<List<NodeDto>>($"api/servers/{selectedServerId}/nodes");
                
                // Reload servers list to update IsSwarmManager property
                await LoadServers();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading nodes");
            isSwarmActive = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task RefreshNodes()
    {
        await LoadNodes();
    }
    
    private async Task InitializeSwarm()
    {
        try
        {
            var response = await Http.PostAsync($"api/servers/{selectedServerId}/swarm/init", null);
            if (response.IsSuccessStatusCode)
            {
                await LoadNodes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing swarm");
        }
    }
    
    private async Task DrainNode(string nodeId)
    {
        try
        {
            var response = await Http.PutAsJsonAsync($"api/servers/{selectedServerId}/nodes/{nodeId}", 
                new { Availability = "drain" });
            if (response.IsSuccessStatusCode)
            {
                await LoadNodes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error draining node");
        }
    }
    
    private async Task ActivateNode(string nodeId)
    {
        try
        {
            var response = await Http.PutAsJsonAsync($"api/servers/{selectedServerId}/nodes/{nodeId}", 
                new { Availability = "active" });
            if (response.IsSuccessStatusCode)
            {
                await LoadNodes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error activating node");
        }
    }
    
    private async Task PromoteNode(string nodeId)
    {
        try
        {
            var response = await Http.PutAsJsonAsync($"api/servers/{selectedServerId}/nodes/{nodeId}", 
                new { Role = "manager" });
            if (response.IsSuccessStatusCode)
            {
                await LoadNodes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error promoting node");
        }
    }
    
    private async Task DemoteNode(string nodeId)
    {
        try
        {
            var response = await Http.PutAsJsonAsync($"api/servers/{selectedServerId}/nodes/{nodeId}", 
                new { Role = "worker" });
            if (response.IsSuccessStatusCode)
            {
                await LoadNodes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error demoting node");
        }
    }
    
    private async Task RemoveNode(string nodeId)
    {
        try
        {
            var response = await Http.DeleteAsync($"api/servers/{selectedServerId}/nodes/{nodeId}?force=true");
            if (response.IsSuccessStatusCode)
            {
                await LoadNodes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error removing node");
        }
    }
    
    private async Task ShowJoinTokens()
    {
        showJoinTokensModal = true;
        copiedMessage = null;
        
        try
        {
            joinTokens = await Http.GetFromJsonAsync<JoinTokensDto>($"api/servers/{selectedServerId}/swarm/tokens");
            
            if (joinTokens != null)
            {
                var server = servers?.FirstOrDefault(s => s.Id == selectedServerId);
                var managerAddress = server != null ? $"{server.Host}:2377" : "MANAGER_IP:2377";
                
                workerJoinCommand = $"docker swarm join --token {joinTokens.WorkerToken} {managerAddress}";
                managerJoinCommand = $"docker swarm join --token {joinTokens.ManagerToken} {managerAddress}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading join tokens");
        }
        
        StateHasChanged();
    }
    
    private void CloseJoinTokens()
    {
        showJoinTokensModal = false;
        joinTokens = null;
        copiedMessage = null;
    }
    
    private async Task CopyToClipboard(string text)
    {
        // In a real implementation, this would use JavaScript interop to copy to clipboard
        copiedMessage = "‚úÖ Copied to clipboard!";
        StateHasChanged();
        
        await Task.Delay(2000);
        copiedMessage = null;
        StateHasChanged();
    }
    
    private string GetNodeStatusClass(NodeDto node)
    {
        if (node.State != "ready") return "node-down";
        if (node.Availability == "drain") return "node-drain";
        return "node-ready";
    }
    
    private string FormatCPU(long nanoCPUs) => $"{nanoCPUs / 1_000_000_000.0:F2}";
    private string FormatMemory(long bytes) => $"{bytes / 1024.0 / 1024.0 / 1024.0:F2} GB";
    
    public class ServerDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Host { get; set; } = "";
        public HostCraft.Core.Enums.ServerType Type { get; set; }
        public bool IsSwarmManager { get; set; }
    }
    
    private record NodeDto(string Id, string Hostname, string Role, string State, string Availability, 
        bool IsLeader, string Address, long NanoCPUs, long MemoryBytes, string EngineVersion, string Platform);
    private record SystemInfoDto(bool SwarmActive);
    private record JoinTokensDto(string WorkerToken, string ManagerToken);
}
