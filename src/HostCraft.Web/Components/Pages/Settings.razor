@page "/settings"
@rendermode InteractiveServer
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Settings - HostCraft</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>‚öôÔ∏è Settings</h1>
        <p class="page-subtitle">Application configuration and system information</p>
    </div>

    <!-- Development Status Warning -->
    <div class="alert" style="margin-bottom: 1.5rem; padding: 1rem; background: #451a03; border-left: 4px solid #f59e0b; border-radius: 6px;">
        <strong style="color: #fbbf24;">‚ö†Ô∏è Alpha Development Version</strong>
        <p style="margin: 0.5rem 0 0 0; color: #fde68a;">This is an <strong>alpha/development</strong> build (v0.0.1-alpha) and is <strong>NOT production-ready</strong>. Expect bugs, breaking changes, and potential data loss. Use at your own risk in non-production environments only.</p>
    </div>

    <!-- HostCraft Domain Configuration -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <span>üåê</span> HostCraft Domain & SSL
            </h2>
        </div>
        <div class="settings-section">
            <p style="margin-bottom: 1.5rem; color: #a3a3a3;">Configure the domain and SSL certificate for accessing the HostCraft control panel.</p>
            
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="hostcraftDomain" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">HostCraft Domain</label>
                <input type="text" id="hostcraftDomain" @bind="hostcraftDomain" class="form-control" placeholder="hostcraft.example.com" style="max-width: 500px;" />
                <small style="display: block; margin-top: 0.5rem; color: #a3a3a3;">Domain for accessing the HostCraft UI</small>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" @bind="hostcraftEnableHttps" style="width: 18px; height: 18px;" />
                    <span style="font-weight: 500;">üîí Enable HTTPS (Let's Encrypt)</span>
                </label>
                <small style="display: block; margin-top: 0.5rem; margin-left: 1.75rem; color: #a3a3a3;">Automatically provision SSL certificate for HostCraft UI</small>
            </div>

            @if (hostcraftEnableHttps)
            {
                <div class="form-group" style="margin-bottom: 1.5rem; margin-left: 1.75rem;">
                    <label for="hostcraftEmail" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Let's Encrypt Email</label>
                    <input type="email" id="hostcraftEmail" @bind="hostcraftLetsEncryptEmail" class="form-control" placeholder="admin@example.com" style="max-width: 500px;" />
                    <small style="display: block; margin-top: 0.5rem; color: #a3a3a3;">Required for SSL certificate notifications</small>
                </div>
            }

            <div class="action-buttons" style="margin-top: 1.5rem;">
                <button class="btn btn-primary" @onclick="SaveHostCraftDomain" disabled="@savingDomain">
                    @if (savingDomain)
                    {
                        <span class="spinner-sm"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>üíæ Save Configuration</span>
                    }
                </button>
            </div>

            @if (!string.IsNullOrEmpty(domainError))
            {
                <div class="alert alert-danger" style="margin-top: 1rem;">
                    <strong>Error:</strong> @domainError
                </div>
            }

            @if (!string.IsNullOrEmpty(domainSuccess))
            {
                <div class="alert alert-success" style="margin-top: 1rem;">
                    <strong>Success:</strong> @domainSuccess
                </div>
            }
        </div>
    </div>

    <!-- Version & Updates Section -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <span>üîÑ</span> Version & Updates
            </h2>
            @if (updateInfo?.UpdateAvailable == true)
            {
                <span class="badge badge-success">Update Available</span>
            }
            else if (checkingForUpdates)
            {
                <span class="badge">Checking...</span>
            }
            else
            {
                <span class="badge badge-info">Up to Date</span>
            }
        </div>

        <div class="settings-section">
            <div class="version-info">
                <div class="info-row">
                    <span class="label">Current Version:</span>
                    <span class="value">
                        <code>v@(versionInfo?.Version ?? "Loading...")</code>
                    </span>
                </div>
                @if (versionInfo != null)
                {
                    <div class="info-row">
                        <span class="label">Build Date:</span>
                        <span class="value">@versionInfo.BuildDate.ToString("MMMM dd, yyyy HH:mm")</span>
                    </div>
                }
                @if (updateInfo != null)
                {
                    @if (updateInfo.UpdateAvailable && !string.IsNullOrEmpty(updateInfo.LatestVersion))
                    {
                        <div class="info-row highlight">
                            <span class="label">Latest Version:</span>
                            <span class="value">
                                <code>v@updateInfo.LatestVersion</code>
                                <span class="badge badge-success">New!</span>
                            </span>
                        </div>
                        @if (updateInfo.PublishedAt.HasValue)
                        {
                            <div class="info-row">
                                <span class="label">Released:</span>
                                <span class="value">@updateInfo.PublishedAt.Value.ToString("MMMM dd, yyyy")</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(updateInfo.ReleaseNotes))
                        {
                            <div class="release-notes">
                                <h3>Release Notes:</h3>
                                <div class="notes-content">@updateInfo.ReleaseNotes</div>
                            </div>
                        }
                    }
                }

                <div class="action-buttons">
                    <button class="btn btn-outline" @onclick="CheckForUpdates" disabled="@checkingForUpdates">
                        @if (checkingForUpdates)
                        {
                            <span class="spinner-sm"></span>
                            <span>Checking...</span>
                        }
                        else
                        {
                            <span>üîç Check for Updates</span>
                        }
                    </button>

                    @if (updateInfo?.UpdateAvailable == true && !string.IsNullOrEmpty(updateInfo.HtmlUrl))
                    {
                        <a href="@updateInfo.HtmlUrl" target="_blank" class="btn btn-primary">
                            üì• View Release
                        </a>
                    }

                    @if (updateInfo?.UpdateAvailable == true)
                    {
                        <button class="btn btn-success" @onclick="TriggerUpdate" disabled="@updatingInProgress">
                            @if (updatingInProgress)
                            {
                                <span class="spinner-sm"></span>
                                <span>Updating...</span>
                            }
                            else
                            {
                                <span>‚¨ÜÔ∏è Update Now</span>
                            }
                        </button>
                    }
                </div>

                @if (!string.IsNullOrEmpty(updateError))
                {
                    <div class="alert alert-danger">
                        <strong>Error:</strong> @updateError
                    </div>
                }

                @if (!string.IsNullOrEmpty(updateSuccess))
                {
                    <div class="alert alert-success">
                        <strong>Success:</strong> @updateSuccess
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- System Information -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <span>üíª</span> System Information
            </h2>
        </div>

        <div class="settings-section">
            <div class="info-grid">
                <div class="info-item">
                    <span class="label">Platform:</span>
                    <span class="value">@GetPlatform()</span>
                </div>
                <div class="info-item">
                    <span class="label">Runtime:</span>
                    <span class="value">.NET @Environment.Version.ToString()</span>
                </div>
                <div class="info-item">
                    <span class="label">Architecture:</span>
                    <span class="value">@GetArchitecture()</span>
                </div>
                <div class="info-item">
                    <span class="label">Working Directory:</span>
                    <span class="value"><code>@Environment.CurrentDirectory</code></span>
                </div>
            </div>
        </div>
    </div>

    <!-- About Section -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <span>‚ÑπÔ∏è</span> About HostCraft
            </h2>
        </div>

        <div class="settings-section">
            <div class="about-content">
                <p>
                    <strong>HostCraft</strong> is a self-hosted Docker Platform-as-a-Service (PaaS) 
                    that simplifies container orchestration and deployment management.
                </p>
                <div class="about-links">
                    <a href="https://github.com/gokartn/hostcraft" target="_blank" class="about-link">
                        üìö Documentation
                    </a>
                    <a href="https://github.com/gokartn/hostcraft" target="_blank" class="about-link">
                        üêô GitHub Repository
                    </a>
                    <a href="https://github.com/gokartn/hostcraft/issues" target="_blank" class="about-link">
                        üêõ Report Issue
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private VersionInfo? versionInfo;
    private UpdateInfo? updateInfo;
    private bool checkingForUpdates = false;
    private bool updatingInProgress = false;
    private string? updateError;
    private string? updateSuccess;
    
    private string? hostcraftDomain;
    private bool hostcraftEnableHttps = true;
    private string? hostcraftLetsEncryptEmail;
    private bool savingDomain = false;
    private string? domainError;
    private string? domainSuccess;

    protected override async Task OnInitializedAsync()
    {
        await LoadVersion();
        await CheckForUpdates();
        await LoadHostCraftDomain();
    }

    private async Task LoadHostCraftDomain()
    {
        try
        {
            var settings = await Http.GetFromJsonAsync<SystemSettingsDto>("api/systemsettings");
            if (settings != null)
            {
                hostcraftDomain = settings.HostCraftDomain ?? "91.99.81.132:5000";
                hostcraftEnableHttps = settings.HostCraftEnableHttps;
                hostcraftLetsEncryptEmail = settings.HostCraftLetsEncryptEmail;
            }
        }
        catch (Exception ex)
        {
            domainError = $"Failed to load domain configuration: {ex.Message}";
            // Set defaults
            hostcraftDomain = "91.99.81.132:5000";
            hostcraftEnableHttps = false;
        }
    }

    private async Task SaveHostCraftDomain()
    {
        savingDomain = true;
        domainError = null;
        domainSuccess = null;

        try
        {
            // Validate
            if (string.IsNullOrWhiteSpace(hostcraftDomain))
            {
                domainError = "Domain is required";
                savingDomain = false;
                return;
            }

            if (hostcraftEnableHttps && string.IsNullOrWhiteSpace(hostcraftLetsEncryptEmail))
            {
                domainError = "Email is required when HTTPS is enabled";
                savingDomain = false;
                return;
            }

            // Call API to save HostCraft domain configuration
            var request = new ConfigureHostCraftRequest(
                hostcraftDomain,
                hostcraftEnableHttps,
                hostcraftLetsEncryptEmail
            );

            var response = await Http.PostAsJsonAsync("api/systemsettings", request);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ConfigureHostCraftResponse>();
                if (result?.Success == true)
                {
                    domainSuccess = result.Message + " Note: You may need to restart the web service for changes to take full effect.";
                }
                else
                {
                    domainError = result?.Message ?? "Configuration failed";
                }
            }
            else
            {
                var errorText = await response.Content.ReadAsStringAsync();
                domainError = $"Failed to save configuration: {errorText}";
            }
        }
        catch (Exception ex)
        {
            domainError = $"Failed to save domain configuration: {ex.Message}";
        }
        finally
        {
            savingDomain = false;
        }
    }

    private record SystemSettingsDto(
        string? HostCraftDomain,
        bool HostCraftEnableHttps,
        string? HostCraftLetsEncryptEmail,
        string? CertificateStatus,
        DateTime? ConfiguredAt,
        DateTime? ProxyUpdatedAt);

    private record ConfigureHostCraftRequest(
        string Domain,
        bool EnableHttps,
        string? LetsEncryptEmail);

    private record ConfigureHostCraftResponse(
        bool Success,
        string Message,
        string? Domain,
        bool HttpsEnabled);

    private async Task LoadVersion()
    {
        try
        {
            versionInfo = await Http.GetFromJsonAsync<VersionInfo>("api/update/version");
        }
        catch (Exception ex)
        {
            updateError = $"Failed to load version: {ex.Message}";
        }
    }

    private async Task CheckForUpdates()
    {
        checkingForUpdates = true;
        updateError = null;
        updateSuccess = null;

        try
        {
            updateInfo = await Http.GetFromJsonAsync<UpdateInfo>("api/update/check");
            
            if (updateInfo?.UpdateAvailable == true)
            {
                updateSuccess = $"New version {updateInfo.LatestVersion} is available!";
            }
        }
        catch (Exception ex)
        {
            updateError = $"Failed to check for updates: {ex.Message}";
        }
        finally
        {
            checkingForUpdates = false;
        }
    }

    private async Task TriggerUpdate()
    {
        if (updateInfo == null || string.IsNullOrEmpty(updateInfo.LatestVersion)) return;

        var confirmed = await JS.InvokeAsync<bool>(
            "confirm", 
            $"Are you sure you want to update to version {updateInfo.LatestVersion}? The application will restart."
        );

        if (!confirmed) return;

        updatingInProgress = true;
        updateError = null;
        updateSuccess = null;

        try
        {
            var response = await Http.PostAsJsonAsync("api/update/trigger", new { Version = updateInfo.LatestVersion });
            
            if (response.IsSuccessStatusCode)
            {
                updateSuccess = "Update triggered successfully! The application will restart shortly.";
            }
            else
            {
                updateError = "Update trigger failed. Please check the deployment configuration.";
            }
        }
        catch (Exception ex)
        {
            updateError = $"Failed to trigger update: {ex.Message}";
        }
        finally
        {
            updatingInProgress = false;
        }
    }

    private string GetPlatform()
    {
        if (OperatingSystem.IsWindows()) return "Windows";
        if (OperatingSystem.IsLinux()) return "Linux";
        if (OperatingSystem.IsMacOS()) return "macOS";
        return "Unknown";
    }

    private string GetArchitecture()
    {
        return System.Runtime.InteropServices.RuntimeInformation.ProcessArchitecture.ToString();
    }

    public class VersionInfo
    {
        public string Version { get; set; } = "";
        public DateTime BuildDate { get; set; }
    }

    public class UpdateInfo
    {
        public string CurrentVersion { get; set; } = "";
        public string? LatestVersion { get; set; }
        public bool UpdateAvailable { get; set; }
        public DateTime? PublishedAt { get; set; }
        public string? ReleaseNotes { get; set; }
        public string? DownloadUrl { get; set; }
        public string? HtmlUrl { get; set; }
    }
}
