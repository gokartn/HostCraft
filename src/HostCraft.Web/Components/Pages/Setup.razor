@page "/setup"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>HostCraft Setup</PageTitle>

@if (IsLoading)
{
    <p>Loading...</p>
}
else if (!SetupRequired)
{
    <h2>Setup Already Complete</h2>
    <p>HostCraft has already been configured.</p>
    <button @onclick="NavigateToLogin">Go to Login</button>
}
else
{
    <h1>Welcome to HostCraft</h1>
    <p>Let's set up your first administrator account.</p>
    
    <form @onsubmit="HandleSetup">
        <div>
            <label>Email:</label>
            <input @bind="Email" type="email" required />
        </div>
        <div>
            <label>Name:</label>
            <input @bind="Name" required />
        </div>
        <div>
            <label>Password:</label>
            <input @bind="Password" type="password" required />
        </div>
        <div>
            <label>Confirm Password:</label>
            <input @bind="ConfirmPassword" type="password" required />
        </div>
        
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <p style="color: red;">@ErrorMessage</p>
        }
        
        <button type="submit" disabled="@IsSubmitting">
            @if (IsSubmitting) { <span>Setting up...</span> } else { <span>Complete Setup</span> }
        </button>
    </form>
}

@code {
    [Inject] ILogger<Setup> Logger { get; set; } = null!;

    private bool IsLoading = true;
    private bool SetupRequired = false;
    private bool IsSubmitting = false;
    private string Email = "";
    private string Name = "";
    private string Password = "";
    private string ConfirmPassword = "";
    private string ErrorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await CheckSetupStatus();
    }

    private async Task CheckSetupStatus()
    {
        try
        {
            var response = await Http.GetAsync("api/auth/setup-required");
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<SetupStatusResponse>();
                SetupRequired = result?.SetupRequired ?? false;
            }
            else
            {
                Logger.LogWarning("Failed to check setup status: {StatusCode}", response.StatusCode);
                SetupRequired = true;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking setup status");
            SetupRequired = true;
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleSetup()
    {
        if (string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(Name) ||
            string.IsNullOrWhiteSpace(Password) || string.IsNullOrWhiteSpace(ConfirmPassword))
        {
            ErrorMessage = "All fields are required.";
            return;
        }

        if (Password != ConfirmPassword)
        {
            ErrorMessage = "Passwords do not match.";
            return;
        }

        if (Password.Length < 8)
        {
            ErrorMessage = "Password must be at least 8 characters long.";
            return;
        }

        if (!Password.Any(char.IsUpper) || !Password.Any(char.IsLower) || !Password.Any(char.IsDigit))
        {
            ErrorMessage = "Password must contain uppercase, lowercase, and numbers.";
            return;
        }

        IsSubmitting = true;
        ErrorMessage = "";

        try
        {
            var setupRequest = new SetupRequest
            {
                Email = Email.Trim(),
                Name = Name.Trim(),
                Password = Password
            };

            var response = await Http.PostAsJsonAsync("api/auth/setup", setupRequest);

            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Setup completed successfully!");
                Navigation.NavigateTo("/login");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                ErrorMessage = $"Setup failed: {error}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during setup");
            ErrorMessage = "An error occurred during setup.";
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    public class SetupStatusResponse
    {
        public bool SetupRequired { get; set; }
    }

    public class SetupRequest
    {
        public string Email { get; set; } = "";
        public string Name { get; set; } = "";
        public string Password { get; set; } = "";
    }
}