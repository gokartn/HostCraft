@page "/applications/new"
@page "/applications/{Id:int}/edit"
@rendermode InteractiveServer
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ILogger<ApplicationForm> Logger

<div class="page-container">
    <div class="page-header">
        <div class="header-left">
            <h1>@(IsEditMode ? "‚úèÔ∏è Edit Application" : "‚ûï Deploy New Application")</h1>
            <p class="subtitle">@(IsEditMode ? "Update application configuration" : "Configure and deploy your application")</p>
        </div>
    </div>

    <div class="form-container">
        @if (isLoading)
        {
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>
        }
        else
        {
            <div class="form-card">
                <div class="form-section">
                    <h2>Basic Information</h2>
                    
                    <div class="form-group">
                        <label for="name">Application Name *</label>
                        <input type="text" id="name" @bind="model.Name" class="form-control" placeholder="my-awesome-app" />
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" @bind="model.Description" class="form-control" rows="3" placeholder="What does this application do?"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="server">Server *</label>
                            <select id="server" @bind="model.ServerId" @bind:after="OnServerChanged" class="form-control">
                                <option value="0">-- Select Server --</option>
                                @if (servers != null)
                                {
                                    foreach (var server in servers)
                                    {
                                        <option value="@server.Id">@server.Name @(server.IsSwarm ? "üêù Swarm" : "üê≥ Standalone")</option>
                                    }
                                }
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="project">Project *</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="project" @bind="model.ProjectId" class="form-control" style="flex: 1;">
                                    <option value="0">-- Select Project --</option>
                                    @if (projects != null)
                                    {
                                        foreach (var project in projects)
                                        {
                                            <option value="@project.Id">@project.Name</option>
                                        }
                                    }
                                </select>
                                <button type="button" class="btn btn-secondary" @onclick="ShowCreateProject" title="Create New Project" style="white-space: nowrap;">
                                    ‚ûï New
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>Source Configuration</h2>

                    <div class="form-group">
                        <label>Deployment Source</label>
                        <div class="source-type-selector">
                            <button type="button" class="source-option @(model.SourceType == "DockerImage" ? "active" : "")"
                                    @onclick="@(() => SetSourceType("DockerImage"))">
                                <span class="source-icon">üê≥</span>
                                <span class="source-label">Docker Image</span>
                                <span class="source-desc">Deploy from Docker Hub or registry</span>
                            </button>
                            <button type="button" class="source-option @(model.SourceType == "Git" ? "active" : "")"
                                    @onclick="@(() => SetSourceType("Git"))">
                                <span class="source-icon">üêô</span>
                                <span class="source-label">Git Repository</span>
                                <span class="source-desc">Build and deploy from source code</span>
                            </button>
                        </div>
                    </div>

                    @if (model.SourceType == "DockerImage")
                    {
                        <div class="form-group">
                            <label for="image">Docker Image *</label>
                            <input type="text" id="image" @bind="model.Image" class="form-control" placeholder="nginx:latest" />
                            <small class="form-hint">Format: image:tag or registry/image:tag</small>
                        </div>
                    }
                    else if (model.SourceType == "Git")
                    {
                        <div class="form-group">
                            <label for="gitProvider">Git Provider *</label>
                            <select id="gitProvider" @bind="selectedGitProviderId" @bind:after="OnGitProviderChanged" class="form-control">
                                <option value="0">-- Select Git Provider --</option>
                                @if (gitProviders != null)
                                {
                                    foreach (var provider in gitProviders)
                                    {
                                        <option value="@provider.Id">@GetProviderIcon(provider.Type) @provider.Name (@@provider.Username)</option>
                                    }
                                }
                            </select>
                            @if (gitProviders == null || !gitProviders.Any())
                            {
                                <small class="form-hint">
                                    <a href="/settings/git-providers">Connect a Git provider</a> to deploy from repositories
                                </small>
                            }
                        </div>

                        @if (selectedGitProviderId > 0)
                        {
                            <div class="form-group">
                                <label for="repository">Repository *</label>
                                @if (loadingRepos)
                                {
                                    <div class="loading-inline"><span class="spinner-sm"></span> Loading repositories...</div>
                                }
                                else
                                {
                                    <select id="repository" @bind="model.GitRepository" @bind:after="OnRepositoryChanged" class="form-control">
                                        <option value="">-- Select Repository --</option>
                                        @if (gitRepositories != null)
                                        {
                                            foreach (var repo in gitRepositories)
                                            {
                                                <option value="@repo.FullName">@repo.FullName @(repo.IsPrivate ? "üîí" : "")</option>
                                            }
                                        }
                                    </select>
                                }
                            </div>

                            @if (!string.IsNullOrEmpty(model.GitRepository))
                            {
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="branch">Branch *</label>
                                        @if (loadingBranches)
                                        {
                                            <div class="loading-inline"><span class="spinner-sm"></span> Loading branches...</div>
                                        }
                                        else
                                        {
                                            <select id="branch" @bind="model.GitBranch" class="form-control">
                                                @if (gitBranches != null)
                                                {
                                                    foreach (var branch in gitBranches)
                                                    {
                                                        <option value="@branch">@branch</option>
                                                    }
                                                }
                                            </select>
                                        }
                                    </div>

                                    <div class="form-group">
                                        <label for="buildPath">Dockerfile Path</label>
                                        <input type="text" id="buildPath" @bind="model.DockerfilePath" class="form-control" placeholder="Dockerfile" />
                                        <small class="form-hint">Path to Dockerfile (default: Dockerfile)</small>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" @bind="model.AutoDeployOnPush" class="form-checkbox" />
                                        <span>üîÑ Auto-deploy on push</span>
                                    </label>
                                    <small class="form-hint">Automatically deploy when new commits are pushed to the selected branch</small>
                                </div>
                            }
                        }
                    }
                </div>

                <div class="form-section">
                    <h2>Container Configuration</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="port">Port</label>
                            <input type="number" id="port" @bind="model.Port" class="form-control" placeholder="8080" />
                            <small class="form-hint">Internal container port</small>
                        </div>
                        
                        @if (selectedServerIsSwarm)
                        {
                            <div class="form-group">
                                <label for="replicas">Replicas</label>
                                <input type="number" id="replicas" @bind="model.Replicas" class="form-control" min="1" max="10" />
                                <small class="form-hint">Number of container instances</small>
                            </div>
                        }
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>Environment Variables</h2>
                    <p class="form-hint">Add environment variables for your application</p>
                    
                    @foreach (var (key, index) in envVars.Select((kv, i) => (kv, i)))
                    {
                        <div class="env-var-row">
                            <input type="text" @bind="key.Key" placeholder="KEY" class="form-control env-key" />
                            <span class="env-separator">=</span>
                            <input type="text" @bind="key.Value" placeholder="value" class="form-control env-value" />
                            <button type="button" class="btn-icon btn-danger" @onclick="() => RemoveEnvVar(index)">üóëÔ∏è</button>
                        </div>
                    }
                    
                    <button type="button" class="btn btn-secondary" @onclick="AddEnvVar">
                        ‚ûï Add Variable
                    </button>
                </div>
                
                <div class="form-section" style="background: rgba(99, 102, 241, 0.05); border-left: 3px solid #6366f1; padding: 1.5rem; border-radius: 8px;">
                    <h2 style="color: #6366f1;">üåê Domain & SSL Configuration</h2>
                    <p class="form-hint">Configure custom domain and automatic HTTPS with Let's Encrypt</p>
                    
                    <div class="form-group">
                        <label for="domain">Primary Domain</label>
                        <input type="text" id="domain" @bind="model.Domain" class="form-control" placeholder="example.com or app.example.com" />
                        <small class="form-hint">Your application's public domain name</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="additionalDomains">Additional Domains</label>
                        <input type="text" id="additionalDomains" @bind="model.AdditionalDomains" class="form-control" placeholder="www.example.com, app2.example.com" />
                        <small class="form-hint">Comma-separated list of additional domain aliases</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label class="checkbox-label">
                                <input type="checkbox" @bind="model.EnableHttps" class="form-checkbox" />
                                <span>üîí Enable HTTPS (Let's Encrypt)</span>
                            </label>
                            <small class="form-hint">Automatically provision and renew SSL certificates</small>
                        </div>
                        
                        @if (model.EnableHttps)
                        {
                            <div class="form-group" style="flex: 1;">
                                <label class="checkbox-label">
                                    <input type="checkbox" @bind="model.ForceHttps" class="form-checkbox" />
                                    <span>Force HTTPS Redirect</span>
                                </label>
                                <small class="form-hint">Redirect all HTTP traffic to HTTPS</small>
                            </div>
                        }
                    </div>
                    
                    @if (model.EnableHttps)
                    {
                        <div class="form-group">
                            <label for="letsencryptEmail">Let's Encrypt Email *</label>
                            <input type="email" id="letsencryptEmail" @bind="model.LetsEncryptEmail" class="form-control" placeholder="admin@example.com" />
                            <small class="form-hint">Required for SSL certificate notifications and renewals</small>
                        </div>
                    }
                </div>
                
                <div class="form-section">
                    <h2>Network Configuration</h2>
                    <p class="form-hint">Docker networks to connect (optional)</p>
                    
                    @foreach (var (network, index) in networks.Select((n, i) => (n, i)))
                    {
                        <div class="network-row">
                            <input type="text" @bind="networks[index]" placeholder="network-name" class="form-control" />
                            <button type="button" class="btn-icon btn-danger" @onclick="() => RemoveNetwork(index)">üóëÔ∏è</button>
                        </div>
                    }
                    
                    <button type="button" class="btn btn-secondary" @onclick="AddNetwork">
                        ‚ûï Add Network
                    </button>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="Deploy" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span>üîÑ Deploying...</span>
                        }
                        else
                        {
                            <span>üöÄ Deploy Application</span>
                        }
                    </button>
                </div>
                
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger">
                        ‚ö†Ô∏è @errorMessage
                    </div>
                }
            </div>
        }
    </div>
</div>

@if (showCreateProjectModal)
{
    <div class="modal-backdrop" @onclick="HideCreateProject">
        <div class="modal-dialog" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Create New Project</h3>
                <button type="button" class="btn-close" @onclick="HideCreateProject">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newProjectName">Project Name *</label>
                    <input type="text" id="newProjectName" @bind="newProjectName" class="form-control" placeholder="my-project" autofocus />
                </div>
                <div class="form-group">
                    <label for="newProjectDescription">Description</label>
                    <textarea id="newProjectDescription" @bind="newProjectDescription" class="form-control" rows="3" placeholder="What is this project for?"></textarea>
                </div>
                @if (!string.IsNullOrEmpty(projectErrorMessage))
                {
                    <div class="alert alert-danger">
                        ‚ö†Ô∏è @projectErrorMessage
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="HideCreateProject">Cancel</button>
                <button type="button" class="btn btn-primary" @onclick="CreateProject" disabled="@isCreatingProject">
                    @if (isCreatingProject)
                    {
                        <span>Creating...</span>
                    }
                    else
                    {
                        <span>Create Project</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int? Id { get; set; }
    
    private bool IsEditMode => Id.HasValue;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private string? errorMessage;
    private bool selectedServerIsSwarm = false;
    
    private List<ServerDto>? servers;
    private List<ProjectDto>? projects;
    private List<GitProviderDto>? gitProviders;
    private List<GitRepositoryDto>? gitRepositories;
    private List<string>? gitBranches;
    private int selectedGitProviderId;
    private bool loadingRepos;
    private bool loadingBranches;

    private bool showCreateProjectModal = false;
    private bool isCreatingProject = false;
    private string newProjectName = "";
    private string newProjectDescription = "";
    private string? projectErrorMessage;
    
    private ApplicationFormModel model = new();
    private List<EnvVar> envVars = new();
    private List<string> networks = new();
    
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        isLoading = false;
    }
    
    private async Task LoadData()
    {
        try
        {
            // Load servers, projects, and git providers in parallel
            var serversTask = Http.GetFromJsonAsync<List<ServerDto>>("api/applications/servers/0");
            var projectsTask = Http.GetFromJsonAsync<List<ProjectDto>>("api/applications/projects");
            var gitProvidersTask = Http.GetFromJsonAsync<List<GitProviderDto>>("api/gitproviders");

            await Task.WhenAll(serversTask, projectsTask, gitProvidersTask);

            servers = serversTask.Result;
            projects = projectsTask.Result;
            gitProviders = gitProvidersTask.Result?.Where(p => p.IsActive).ToList();
            
            if (IsEditMode && Id.HasValue)
            {
                // Load existing application
                var app = await Http.GetFromJsonAsync<ApplicationWithDeploymentsDto>($"api/applications/{Id.Value}");
                if (app != null)
                {
                    model = new ApplicationFormModel
                    {
                        Name = app.Name,
                        Description = app.Description,
                        ServerId = app.ServerId,
                        ProjectId = app.ProjectId,
                        Image = app.DockerImage ?? "",
                        Port = app.Port,
                        Replicas = app.Replicas,
                        Domain = app.Domain,
                        AdditionalDomains = app.AdditionalDomains,
                        EnableHttps = app.EnableHttps,
                        ForceHttps = app.ForceHttps,
                        LetsEncryptEmail = app.LetsEncryptEmail
                    };
                    
                    if (app.EnvironmentVariables != null)
                    {
                        envVars = app.EnvironmentVariables.Select(kv => new EnvVar { Key = kv.Key, Value = kv.Value }).ToList();
                    }
                    
                    UpdateServerSwarmStatus();
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading data");
            errorMessage = "Failed to load data";
        }
    }
    
    private void OnServerChanged()
    {
        UpdateServerSwarmStatus();
    }
    
    private void UpdateServerSwarmStatus()
    {
        selectedServerIsSwarm = servers?.FirstOrDefault(s => s.Id == model.ServerId)?.IsSwarm ?? false;
        if (!selectedServerIsSwarm)
        {
            model.Replicas = 1;
        }
    }
    
    private void AddEnvVar()
    {
        envVars.Add(new EnvVar());
    }
    
    private void RemoveEnvVar(int index)
    {
        envVars.RemoveAt(index);
    }
    
    private void AddNetwork()
    {
        networks.Add("");
    }
    
    private void RemoveNetwork(int index)
    {
        networks.RemoveAt(index);
    }

    private void SetSourceType(string type)
    {
        model.SourceType = type;
        if (type == "DockerImage")
        {
            // Clear Git-related fields
            selectedGitProviderId = 0;
            model.GitProviderId = null;
            model.GitRepository = null;
            model.GitBranch = null;
            model.DockerfilePath = null;
            gitRepositories = null;
            gitBranches = null;
        }
        else
        {
            // Clear Docker image field
            model.Image = "";
        }
    }

    private async Task OnGitProviderChanged()
    {
        model.GitProviderId = selectedGitProviderId > 0 ? selectedGitProviderId : null;
        model.GitRepository = null;
        model.GitBranch = null;
        gitRepositories = null;
        gitBranches = null;

        if (selectedGitProviderId > 0)
        {
            loadingRepos = true;
            StateHasChanged();

            try
            {
                gitRepositories = await Http.GetFromJsonAsync<List<GitRepositoryDto>>($"api/gitproviders/{selectedGitProviderId}/repositories");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading repositories");
            }
            finally
            {
                loadingRepos = false;
                StateHasChanged();
            }
        }
    }

    private async Task OnRepositoryChanged()
    {
        gitBranches = null;
        model.GitBranch = null;

        if (!string.IsNullOrEmpty(model.GitRepository) && selectedGitProviderId > 0)
        {
            loadingBranches = true;
            StateHasChanged();

            try
            {
                // Repository is in "owner/repo" format, split it for the API
                var repoParts = model.GitRepository.Split('/');
                var owner = repoParts.Length > 1 ? repoParts[0] : model.GitRepository;
                var repo = repoParts.Length > 1 ? repoParts[1] : model.GitRepository;
                gitBranches = await Http.GetFromJsonAsync<List<string>>($"api/gitproviders/{selectedGitProviderId}/repositories/{owner}/{repo}/branches");

                // Auto-select first branch (usually main/master)
                if (gitBranches?.Any() == true)
                {
                    model.GitBranch = gitBranches.First();
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading branches");
            }
            finally
            {
                loadingBranches = false;
                StateHasChanged();
            }
        }
    }

    private string GetProviderIcon(string type)
    {
        return type.ToLowerInvariant() switch
        {
            "github" => "üêô",
            "gitlab" => "ü¶ä",
            "bitbucket" => "ü™£",
            "gitea" => "üçµ",
            _ => "üì¶"
        };
    }

    private async Task Deploy()
    {
        errorMessage = null;
        
        // Validation
        if (string.IsNullOrWhiteSpace(model.Name))
        {
            errorMessage = "Application name is required";
            return;
        }
        
        if (model.ServerId == 0)
        {
            errorMessage = "Please select a server";
            return;
        }
        
        if (model.ProjectId == 0)
        {
            errorMessage = "Please select a project";
            return;
        }

        // Source-specific validation
        if (model.SourceType == "DockerImage")
        {
            if (string.IsNullOrWhiteSpace(model.Image))
            {
                errorMessage = "Docker image is required";
                return;
            }
        }
        else if (model.SourceType == "Git")
        {
            if (selectedGitProviderId == 0)
            {
                errorMessage = "Please select a Git provider";
                return;
            }
            if (string.IsNullOrWhiteSpace(model.GitRepository))
            {
                errorMessage = "Please select a repository";
                return;
            }
            if (string.IsNullOrWhiteSpace(model.GitBranch))
            {
                errorMessage = "Please select a branch";
                return;
            }
        }

        isSubmitting = true;
        StateHasChanged();
        
        try
        {
            // Validate HTTPS email if HTTPS is enabled
            if (model.EnableHttps && !string.IsNullOrWhiteSpace(model.Domain) && string.IsNullOrWhiteSpace(model.LetsEncryptEmail))
            {
                errorMessage = "Let's Encrypt email is required when HTTPS is enabled";
                isSubmitting = false;
                return;
            }
            
            var request = new CreateApplicationRequest(
                model.Name,
                model.ServerId,
                model.ProjectId,
                model.SourceType == "DockerImage" ? model.Image : null,
                model.Replicas,
                envVars.Where(e => !string.IsNullOrWhiteSpace(e.Key)).ToDictionary(e => e.Key, e => e.Value),
                networks.Where(n => !string.IsNullOrWhiteSpace(n)).ToList(),
                model.Port,
                model.Domain,
                model.AdditionalDomains,
                model.EnableHttps,
                model.ForceHttps,
                model.LetsEncryptEmail,
                model.SourceType,
                model.GitProviderId,
                model.GitRepository,
                model.GitBranch,
                model.DockerfilePath ?? "Dockerfile",
                model.AutoDeployOnPush
            );

            var response = await Http.PostAsJsonAsync("api/applications", request);

            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/applications");
            }
            else
            {
                // Try to get error details from response
                try
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    var errorObj = System.Text.Json.JsonSerializer.Deserialize<ErrorResponse>(errorContent,
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    errorMessage = errorObj?.Error ?? $"Failed to deploy application (Status: {response.StatusCode})";
                }
                catch
                {
                    errorMessage = $"Failed to deploy application (Status: {response.StatusCode})";
                }
                Logger.LogWarning("Deployment failed with status {StatusCode}", response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deploying application");
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }
    
    private void Cancel()
    {
        Navigation.NavigateTo("/applications");
    }
    
    private void ShowCreateProject()
    {
        newProjectName = "";
        newProjectDescription = "";
        projectErrorMessage = null;
        showCreateProjectModal = true;
    }
    
    private void HideCreateProject()
    {
        showCreateProjectModal = false;
        newProjectName = "";
        newProjectDescription = "";
        projectErrorMessage = null;
    }
    
    private async Task CreateProject()
    {
        projectErrorMessage = null;
        
        if (string.IsNullOrWhiteSpace(newProjectName))
        {
            projectErrorMessage = "Project name is required";
            return;
        }
        
        isCreatingProject = true;
        StateHasChanged();
        
        try
        {
            var request = new { Name = newProjectName, Description = newProjectDescription };
            var response = await Http.PostAsJsonAsync("api/projects", request);
            
            if (response.IsSuccessStatusCode)
            {
                var createdProject = await response.Content.ReadFromJsonAsync<ProjectDto>();
                if (createdProject != null)
                {
                    // Reload projects list
                    projects = await Http.GetFromJsonAsync<List<ProjectDto>>("api/applications/projects");
                    
                    // Auto-select the newly created project
                    model.ProjectId = createdProject.Id;
                    
                    HideCreateProject();
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                projectErrorMessage = $"Failed to create project: {errorContent}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating project");
            projectErrorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isCreatingProject = false;
            StateHasChanged();
        }
    }
    
    private class ApplicationFormModel
    {
        public string Name { get; set; } = "";
        public string? Description { get; set; }
        public int ServerId { get; set; }
        public int ProjectId { get; set; }
        public string SourceType { get; set; } = "DockerImage";
        public string Image { get; set; } = "";
        public int? GitProviderId { get; set; }
        public string? GitRepository { get; set; }
        public string? GitBranch { get; set; }
        public string? DockerfilePath { get; set; }
        public bool AutoDeployOnPush { get; set; } = true;
        public int? Port { get; set; }
        public int Replicas { get; set; } = 1;
        public string? Domain { get; set; }
        public string? AdditionalDomains { get; set; }
        public bool EnableHttps { get; set; } = true;
        public bool ForceHttps { get; set; } = true;
        public string? LetsEncryptEmail { get; set; }
    }
    
    private class EnvVar
    {
        public string Key { get; set; } = "";
        public string Value { get; set; } = "";
    }
    
    private record ServerDto(int Id, string Name, string Host, int Port, string User, bool IsSwarm, string Status);
    private record ProjectDto(int Id, string Name, string? Description);
    private record CreateApplicationRequest(
        string Name,
        int ServerId,
        int ProjectId,
        string? Image,
        int? Replicas,
        Dictionary<string, string>? EnvironmentVariables,
        List<string>? Networks,
        int? Port,
        string? Domain = null,
        string? AdditionalDomains = null,
        bool EnableHttps = true,
        bool ForceHttps = true,
        string? LetsEncryptEmail = null,
        string? SourceType = "DockerImage",
        int? GitProviderId = null,
        string? GitRepository = null,
        string? GitBranch = null,
        string? DockerfilePath = null,
        bool AutoDeployOnPush = true);
    private record ApplicationWithDeploymentsDto(
        int Id,
        string Name,
        string? Description,
        int ServerId,
        string ServerName,
        int ProjectId,
        string ProjectName,
        string? DockerImage,
        int? Port,
        int Replicas,
        Dictionary<string, string>? EnvironmentVariables,
        string? Domain,
        string? AdditionalDomains,
        bool EnableHttps,
        bool ForceHttps,
        string? LetsEncryptEmail,
        DeploymentStatus Status,
        string? ContainerId,
        string? ServiceId,
        DateTime? LastDeployedAt,
        DateTime CreatedAt,
        List<DeploymentInfo> Deployments);
    private record DeploymentInfo(int Id, DeploymentStatus Status, string? ContainerId, string? ServiceId, DateTime StartedAt, DateTime? FinishedAt, string? ErrorMessage);
    private record GitProviderDto(int Id, string Name, string Type, string? Username, bool IsActive);
    private record GitRepositoryDto(string Owner, string Name, string FullName, string? Description, string DefaultBranch, string CloneUrl, bool IsPrivate, DateTime? UpdatedAt);
    private record ErrorResponse(string? Error, string? Message);
}
