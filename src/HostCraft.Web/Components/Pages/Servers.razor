@page "/servers"
@rendermode InteractiveServer
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ILogger<Servers> Logger

<PageTitle>Servers - HostCraft</PageTitle>

<div class="servers-page">
    <div class="page-header">
        <div>
            <h1>Servers</h1>
            <p class="subtitle">Manage your Docker hosts and Swarm clusters</p>
        </div>
        <div style="display: flex; gap: 0.75rem;">
            @if (!HasLocalhost())
            {
                <button class="btn btn-secondary" @onclick="ConfigureLocalhost" disabled="@configuringLocalhost">
                    <span class="icon">üñ•Ô∏è</span> @(configuringLocalhost ? "Configuring..." : "Configure Localhost")
                </button>
            }
            @if (servers != null && servers.Any())
            {
                <button class="btn btn-primary" @onclick="NavigateToAdd">
                    <span class="icon">‚ûï</span> Add Server
                </button>
            }
        </div>
    </div>

    @if (loading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading servers...</p>
        </div>
    }
    else if (servers == null || !servers.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">üñ•Ô∏è</div>
            <h2>No Servers Yet</h2>
            <p>Add your first Docker host to start deploying applications</p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary btn-lg" @onclick="ConfigureLocalhost" disabled="@configuringLocalhost">
                    <span class="icon">üñ•Ô∏è</span> @(configuringLocalhost ? "Configuring..." : "Configure Localhost")
                </button>
                <button class="btn btn-primary btn-lg" @onclick="NavigateToAdd">
                    <span class="icon">‚ûï</span> Add Remote Server
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="servers-grid">
            @foreach (var server in servers)
            {
                <div class="server-item @GetStatusClass(server.Status)">
                    <div class="server-header">
                        <h3>@server.Name</h3>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="server-type-badge @GetTypeBadgeClass(server.Type)">
                                @GetTypeIcon(server.Type) @server.Type
                            </span>
                            <span class="status-badge @GetStatusClass(server.Status)">
                                @GetStatusIcon(server.Status) @server.Status
                            </span>
                        </div>
                    </div>

                    <div class="server-info">
                        <div class="info-row">
                            <span class="label">Host:</span>
                            <span class="value">@server.Host:@server.Port</span>
                        </div>
                        <div class="info-row">
                            <span class="label">User:</span>
                            <span class="value">@server.User</span>
                        </div>
                        @if (server.Region != null)
                        {
                            <div class="info-row">
                                <span class="label">Region:</span>
                                <span class="value">@server.Region.Name</span>
                            </div>
                        }
                        @if (server.IsSwarm && !string.IsNullOrEmpty(server.SwarmId))
                        {
                            <div class="info-row">
                                <span class="label">Swarm:</span>
                                <span class="value">@server.SwarmId.Substring(0, 12)</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(server.SwarmNodeState))
                        {
                            <div class="info-row">
                                <span class="label">Node State:</span>
                                <span class="value">@GetNodeStateIcon(server.SwarmNodeState) @server.SwarmNodeState</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(server.SwarmNodeAvailability))
                        {
                            <div class="info-row">
                                <span class="label">Availability:</span>
                                <span class="value">@GetAvailabilityIcon(server.SwarmNodeAvailability) @server.SwarmNodeAvailability</span>
                            </div>
                        }
                    </div>

                    <div class="server-actions">
                        <button class="btn-icon" @onclick="() => NavigateToDetails(server.Id)" title="Details">
                            üîç
                        </button>
                        @if (server.Type == ServerType.Standalone)
                        {
                            <button class="btn-icon btn-primary" @onclick="() => InitializeSwarm(server.Id)" title="Initialize Swarm">
                                üêù
                            </button>
                        }
                        @if (server.IsSwarm)
                        {
                            <button class="btn-icon" @onclick="() => NavigateToSwarmNodes(server.Id)" title="Swarm Nodes">
                                üîó
                            </button>
                        }
                        <button class="btn-icon" @onclick="() => NavigateToEdit(server.Id)" title="Edit">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn-icon btn-danger" @onclick="() => DeleteServer(server.Id)" title="Delete">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<ServerDto>? servers;
    private bool loading = true;
    private bool configuringLocalhost = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadServers();
    }

    private async Task LoadServers()
    {
        loading = true;
        try
        {
            servers = await Http.GetFromJsonAsync<List<ServerDto>>("api/servers");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load servers list");
            servers = new List<ServerDto>();
        }
        finally
        {
            loading = false;
        }
    }

    private bool HasLocalhost()
    {
        return servers?.Any(s => s.Host == "localhost" || s.Host == "127.0.0.1") ?? false;
    }

    private async Task ConfigureLocalhost()
    {
        configuringLocalhost = true;
        try
        {
            var response = await Http.PostAsync("api/servers/configure-localhost", null);
            
            if (response.IsSuccessStatusCode)
            {
                await LoadServers();
                await JS.InvokeVoidAsync("alert", "Localhost server configured successfully!");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Failed to configure localhost: {error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            configuringLocalhost = false;
        }
    }

    private void NavigateToAdd()
    {
        Navigation.NavigateTo("/servers/new");
    }

    private void NavigateToEdit(int id)
    {
        Navigation.NavigateTo($"/servers/{id}/edit");
    }

    private void NavigateToDetails(int id)
    {
        Navigation.NavigateTo($"/servers/{id}");
    }

    private void NavigateToSwarmNodes(int id)
    {
        Navigation.NavigateTo($"/swarm/nodes/{id}");
    }

    private async Task InitializeSwarm(int id)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Initialize Docker Swarm on this server?\n\nThis will make it a Swarm Manager."))
        {
            try
            {
                var response = await Http.PostAsync($"api/servers/{id}/swarm/init", null);
                
                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "‚úÖ Swarm initialized successfully!");
                    await LoadServers();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    await JS.InvokeVoidAsync("alert", $"‚ùå Failed to initialize swarm: {error}");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to initialize Docker Swarm on server {ServerId}", id);
                await JS.InvokeVoidAsync("alert", $"‚ùå Error: {ex.Message}");
            }
        }
    }

    private async Task DeleteServer(int id)
    {
        var server = servers?.FirstOrDefault(s => s.Id == id);
        var serverName = server?.Name ?? $"Server #{id}";
        
        if (await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete {serverName}?\n\nThis action cannot be undone."))
        {
            try
            {
                var response = await Http.DeleteAsync($"api/servers/{id}");
                
                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", $"‚úÖ {serverName} deleted successfully");
                    await LoadServers();
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    var statusCode = (int)response.StatusCode;
                    
                    string errorMessage;
                    if (statusCode == 404)
                    {
                        errorMessage = "Server not found. It may have already been deleted.";
                    }
                    else if (statusCode == 409)
                    {
                        errorMessage = "Cannot delete server with active applications. Please remove all applications first.";
                    }
                    else
                    {
                        errorMessage = $"Failed to delete server ({statusCode}): {errorContent}";
                    }
                    
                    await JS.InvokeVoidAsync("alert", $"‚ùå {errorMessage}");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to delete server {ServerName}", serverName);
                await JS.InvokeVoidAsync("alert", $"‚ùå Error deleting server: {ex.Message}");
            }
        }
    }

    private string GetStatusClass(ServerStatus status)
    {
        return status switch
        {
            ServerStatus.Online => "online",
            ServerStatus.Offline => "offline",
            _ => "error"
        };
    }

    private string GetStatusIcon(ServerStatus status)
    {
        return status switch
        {
            ServerStatus.Online => "üü¢",
            ServerStatus.Offline => "üî¥",
            ServerStatus.Error => "‚ö†Ô∏è",
            _ => "üîÑ"
        };
    }

    private string GetTypeBadgeClass(ServerType type)
    {
        return type switch
        {
            ServerType.SwarmManager => "manager",
            ServerType.SwarmWorker => "worker",
            _ => "standalone"
        };
    }

    private string GetTypeIcon(ServerType type)
    {
        return type switch
        {
            ServerType.SwarmManager => "üëë",
            ServerType.SwarmWorker => "‚öôÔ∏è",
            _ => "üíª"
        };
    }

    private string GetTimeSince(DateTime date)
    {
        var span = DateTime.Now - date;
        if (span.TotalMinutes < 1) return "just now";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes}m ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours}h ago";
        return $"{(int)span.TotalDays}d ago";
    }

    private string GetNodeStateIcon(string state)
    {
        return state.ToLower() switch
        {
            "ready" => "‚úÖ",
            "down" => "üî¥",
            "disconnected" => "‚ö†Ô∏è",
            _ => "‚ö™"
        };
    }

    private string GetAvailabilityIcon(string availability)
    {
        return availability.ToLower() switch
        {
            "active" => "‚úÖ",
            "drain" => "üîÑ",
            "pause" => "‚è∏Ô∏è",
            _ => "‚ö™"
        };
    }

    public class ServerDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Host { get; set; } = "";
        public int Port { get; set; }
        public string Username { get; set; } = "";
        public string User => Username; // Backward compatibility
        public HostCraft.Core.Enums.ServerType Type { get; set; }
        public HostCraft.Core.Enums.ServerStatus Status { get; set; }
        public RegionDto? Region { get; set; }
        public string? SwarmId { get; set; }
        public string? SwarmNodeId { get; set; }
        public string? SwarmNodeState { get; set; }
        public string? SwarmNodeAvailability { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime? LastSeenAt { get; set; }
        public bool IsSwarm => Type == HostCraft.Core.Enums.ServerType.SwarmManager || Type == HostCraft.Core.Enums.ServerType.SwarmWorker;
    }

    public class RegionDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Code { get; set; } = "";
    }
}

<style>
    .servers-page {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
        margin: 0;
    }

    .subtitle {
        color: #94a3b8;
        font-size: 0.95rem;
        margin-top: 0.5rem;
    }

    .btn {
        padding: 0.5rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.95rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
    }

    .btn-secondary {
        background: #334155;
        color: #fff;
    }

    .btn-secondary:hover:not(:disabled) {
        background: #475569;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }

    .loading-state, .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 1rem;
        border: 1px solid #334155;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state h2 {
        color: #fff;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #94a3b8;
        margin-bottom: 1.5rem;
    }

    .spinner {
        border: 3px solid #334155;
        border-top-color: #6366f1;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .servers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 1.5rem;
    }

    .server-item {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 2px solid #334155;
        border-radius: 1rem;
        padding: 1.5rem;
        transition: all 0.3s;
    }

    .server-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    .server-item.online {
        border-color: #10b981;
    }

    .server-item.offline {
        border-color: #ef4444;
        background: linear-gradient(135deg, #1e293b 0%, #2a1215 100%);
    }

    .server-item.error {
        border-color: #f59e0b;
        background: linear-gradient(135deg, #1e293b 0%, #292213 100%);
    }

    .server-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #334155;
    }

    .server-header h3 {
        color: #fff;
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }

    .server-type-badge, .status-badge {
        padding: 0.4rem 0.9rem;
        border-radius: 0.5rem;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
    }

    .server-type-badge.manager {
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        color: #fff;
        box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
    }

    .server-type-badge.worker {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: #fff;
        box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
    }

    .server-type-badge.standalone {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        color: #fff;
        box-shadow: 0 2px 10px rgba(100, 116, 139, 0.3);
    }

    .status-badge.online {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #fff;
    }

    .status-badge.offline {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: #fff;
    }

    .status-badge.error {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: #fff;
    }

    .server-info {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
    }

    .info-row .label {
        color: #94a3b8;
        font-size: 0.85rem;
        font-weight: 500;
        min-width: 100px;
    }

    .info-row .value {
        color: #fff;
        font-size: 0.9rem;
        text-align: right;
        word-break: break-all;
    }

    .server-actions {
        display: flex;
        gap: 0.5rem;
        padding-top: 1rem;
        border-top: 1px solid #334155;
    }

    .btn-icon {
        width: 42px;
        height: 42px;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        border: 1px solid #334155;
        background: #1e293b;
        color: #fff;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .btn-icon.btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-color: #6366f1;
    }

    .btn-icon.btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-color: #ef4444;
    }

    @@media (max-width: 768px) {
        .servers-page {
            padding: 1rem;
        }

        .page-header {
            flex-direction: column;
            align-items: stretch;
        }

        .servers-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
