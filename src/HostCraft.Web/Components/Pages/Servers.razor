@page "/servers"
@rendermode InteractiveServer
@using HostCraft.Core.Enums
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Servers - HostCraft</PageTitle>

<div class="servers-page">
    <div class="page-header">
        <div>
            <h1>Servers</h1>
            <p class="subtitle">Manage your Docker hosts and Swarm clusters</p>
        </div>
        @if (servers != null && servers.Any())
        {
            <button class="btn btn-primary" @onclick="NavigateToAdd">
                <span class="icon">‚ûï</span> Add Server
            </button>
        }
    </div>

    @if (loading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading servers...</p>
        </div>
    }
    else if (servers == null || !servers.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">üñ•Ô∏è</div>
            <h2>No Servers Yet</h2>
            <p>Add your first Docker host to start deploying applications</p>
            <button class="btn btn-primary btn-lg" @onclick="NavigateToAdd">
                <span class="icon">‚ûï</span> Add Your First Server
            </button>
        </div>
    }
    else
    {
        <div class="servers-grid">
            @foreach (var server in servers)
            {
                <div class="server-item @GetStatusClass(server.Status)">
                    <div class="server-header">
                        <div class="server-title">
                            <h3>@server.Name</h3>
                            <span class="server-type-badge @GetTypeBadgeClass(server.Type)">
                                @GetTypeIcon(server.Type) @server.Type
                            </span>
                        </div>
                        <div class="server-actions">
                            <button class="btn-icon" @onclick="() => NavigateToEdit(server.Id)" title="Edit">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn-icon" @onclick="() => NavigateToDetails(server.Id)" title="Details">
                                üîç
                            </button>
                            <button class="btn-icon btn-danger" @onclick="() => DeleteServer(server.Id)" title="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>

                    <div class="server-info">
                        <div class="info-row">
                            <span class="label">Host:</span>
                            <span class="value">@server.Host:@server.Port</span>
                        </div>
                        <div class="info-row">
                            <span class="label">User:</span>
                            <span class="value">@server.User</span>
                        </div>
                        @if (!string.IsNullOrEmpty(server.Region))
                        {
                            <div class="info-row">
                                <span class="label">Region:</span>
                                <span class="value">@server.Region</span>
                            </div>
                        }
                        <div class="info-row">
                            <span class="label">Status:</span>
                            <span class="status-badge @GetStatusClass(server.Status)">
                                @GetStatusIcon(server.Status) @server.Status
                            </span>
                        </div>
                    </div>

                    @if (server.IsSwarm)
                    {
                        <div class="swarm-info">
                            <div class="swarm-badge">üêù Swarm Cluster Member</div>
                            @if (!string.IsNullOrEmpty(server.SwarmId))
                            {
                                <div class="swarm-detail">Cluster: <code>@server.SwarmId.Substring(0, 12)</code></div>
                            }
                        </div>
                    }

                    <div class="server-footer">
                        <small class="text-muted">
                            Added @server.CreatedAt.ToString("MMM dd, yyyy")
                            @if (server.LastSeenAt.HasValue)
                            {
                                <span> ‚Ä¢ Last seen @GetTimeSince(server.LastSeenAt.Value)</span>
                            }
                        </small>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<ServerDto>? servers;
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadServers();
    }

    private async Task LoadServers()
    {
        loading = true;
        try
        {
            servers = await Http.GetFromJsonAsync<List<ServerDto>>("api/servers");
        }
        catch (Exception ex)
        {
            servers = new List<ServerDto>();
        }
        finally
        {
            loading = false;
        }
    }

    private void NavigateToAdd()
    {
        Navigation.NavigateTo("/servers/new");
    }

    private void NavigateToEdit(int id)
    {
        Navigation.NavigateTo($"/servers/{id}/edit");
    }

    private void NavigateToDetails(int id)
    {
        Navigation.NavigateTo($"/servers/{id}");
    }

    private async Task DeleteServer(int id)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this server?"))
        {
            try
            {
                await Http.DeleteAsync($"api/servers/{id}");
                await LoadServers();
            }
            catch (Exception ex)
            {
                // TODO: Show error notification
            }
        }
    }

    private string GetStatusClass(ServerStatus status)
    {
        return status switch
        {
            ServerStatus.Online => "online",
            ServerStatus.Offline => "offline",
            _ => "error"
        };
    }

    private string GetStatusIcon(ServerStatus status)
    {
        return status switch
        {
            ServerStatus.Online => "üü¢",
            ServerStatus.Offline => "üî¥",
            ServerStatus.Error => "‚ö†Ô∏è",
            _ => "üîÑ"
        };
    }

    private string GetTypeBadgeClass(ServerType type)
    {
        return type switch
        {
            ServerType.SwarmManager => "manager",
            ServerType.SwarmWorker => "worker",
            _ => "standalone"
        };
    }

    private string GetTypeIcon(ServerType type)
    {
        return type switch
        {
            ServerType.SwarmManager => "üëë",
            ServerType.SwarmWorker => "‚öôÔ∏è",
            _ => "üíª"
        };
    }

    private string GetTimeSince(DateTime date)
    {
        var span = DateTime.Now - date;
        if (span.TotalMinutes < 1) return "just now";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes}m ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours}h ago";
        return $"{(int)span.TotalDays}d ago";
    }

    public class ServerDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Host { get; set; } = "";
        public int Port { get; set; }
        public string User { get; set; } = "";
        public ServerType Type { get; set; }
        public ServerStatus Status { get; set; }
        public string? Region { get; set; }
        public string? SwarmId { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime? LastSeenAt { get; set; }
        public bool IsSwarm => Type == ServerType.SwarmManager || Type == ServerType.SwarmWorker;
    }
}
