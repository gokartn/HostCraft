@page "/servers"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Servers - HostCraft</PageTitle>

<div class="servers-page">
    <div class="page-header">
        <div>
            <h1>Servers</h1>
            <p class="subtitle">Manage your Docker hosts and Swarm clusters</p>
        </div>
        <div style="display: flex; gap: 0.75rem;">
            @if (!HasLocalhost())
            {
                <button class="btn btn-secondary" @onclick="ConfigureLocalhost" disabled="@configuringLocalhost">
                    <span class="icon">üñ•Ô∏è</span> @(configuringLocalhost ? "Configuring..." : "Configure Localhost")
                </button>
            }
            @if (servers != null && servers.Any())
            {
                <button class="btn btn-primary" @onclick="NavigateToAdd">
                    <span class="icon">‚ûï</span> Add Server
                </button>
            }
        </div>
    </div>

    @if (loading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading servers...</p>
        </div>
    }
    else if (servers == null || !servers.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">üñ•Ô∏è</div>
            <h2>No Servers Yet</h2>
            <p>Add your first Docker host to start deploying applications</p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary btn-lg" @onclick="ConfigureLocalhost" disabled="@configuringLocalhost">
                    <span class="icon">üñ•Ô∏è</span> @(configuringLocalhost ? "Configuring..." : "Configure Localhost")
                </button>
                <button class="btn btn-primary btn-lg" @onclick="NavigateToAdd">
                    <span class="icon">‚ûï</span> Add Remote Server
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="servers-grid">
            @foreach (var server in servers)
            {
                <div class="server-item @GetStatusClass(server.Status)">
                    <div class="server-header">
                        <h3>@server.Name</h3>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="server-type-badge @GetTypeBadgeClass(server.Type)">
                                @GetTypeIcon(server.Type) @server.Type
                            </span>
                            <span class="status-badge @GetStatusClass(server.Status)">
                                @GetStatusIcon(server.Status) @server.Status
                            </span>
                        </div>
                    </div>

                    <div class="server-info">
                        <div class="info-row">
                            <span class="label">Host:</span>
                            <span class="value">@server.Host:@server.Port</span>
                        </div>
                        <div class="info-row">
                            <span class="label">User:</span>
                            <span class="value">@server.User</span>
                        </div>
                        @if (server.Region != null)
                        {
                            <div class="info-row">
                                <span class="label">Region:</span>
                                <span class="value">@server.Region.Name</span>
                            </div>
                        }
                        @if (server.IsSwarm && !string.IsNullOrEmpty(server.SwarmId))
                        {
                            <div class="info-row">
                                <span class="label">Swarm:</span>
                                <span class="value">@server.SwarmId.Substring(0, 12)</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(server.SwarmNodeState))
                        {
                            <div class="info-row">
                                <span class="label">Node State:</span>
                                <span class="value">@GetNodeStateIcon(server.SwarmNodeState) @server.SwarmNodeState</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(server.SwarmNodeAvailability))
                        {
                            <div class="info-row">
                                <span class="label">Availability:</span>
                                <span class="value">@GetAvailabilityIcon(server.SwarmNodeAvailability) @server.SwarmNodeAvailability</span>
                            </div>
                        }
                    </div>

                    <div class="server-actions">
                        <button class="btn-icon" @onclick="() => NavigateToDetails(server.Id)" title="Details">
                            üîç
                        </button>
                        @if (server.Type == ServerType.Standalone)
                        {
                            <button class="btn-icon btn-primary" @onclick="() => InitializeSwarm(server.Id)" title="Initialize Swarm">
                                üêù
                            </button>
                        }
                        @if (server.IsSwarm)
                        {
                            <button class="btn-icon" @onclick="() => NavigateToSwarmNodes(server.Id)" title="Swarm Nodes">
                                üîó
                            </button>
                        }
                        <button class="btn-icon" @onclick="() => NavigateToEdit(server.Id)" title="Edit">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn-icon btn-danger" @onclick="() => DeleteServer(server.Id)" title="Delete">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<ServerDto>? servers;
    private bool loading = true;
    private bool configuringLocalhost = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadServers();
    }

    private async Task LoadServers()
    {
        loading = true;
        try
        {
            servers = await Http.GetFromJsonAsync<List<ServerDto>>("api/servers");
        }
        catch (Exception ex)
        {
            servers = new List<ServerDto>();
        }
        finally
        {
            loading = false;
        }
    }

    private bool HasLocalhost()
    {
        return servers?.Any(s => s.Host == "localhost" || s.Host == "127.0.0.1") ?? false;
    }

    private async Task ConfigureLocalhost()
    {
        configuringLocalhost = true;
        try
        {
            var response = await Http.PostAsync("api/servers/configure-localhost", null);
            
            if (response.IsSuccessStatusCode)
            {
                await LoadServers();
                await JS.InvokeVoidAsync("alert", "Localhost server configured successfully!");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Failed to configure localhost: {error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            configuringLocalhost = false;
        }
    }

    private void NavigateToAdd()
    {
        Navigation.NavigateTo("/servers/new");
    }

    private void NavigateToEdit(int id)
    {
        Navigation.NavigateTo($"/servers/{id}/edit");
    }

    private void NavigateToDetails(int id)
    {
        Navigation.NavigateTo($"/servers/{id}");
    }

    private void NavigateToSwarmNodes(int id)
    {
        Navigation.NavigateTo($"/swarm/nodes/{id}");
    }

    private async Task InitializeSwarm(int id)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Initialize Docker Swarm on this server?\n\nThis will make it a Swarm Manager."))
        {
            try
            {
                var response = await Http.PostAsync($"api/servers/{id}/swarm/init", null);
                
                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", "‚úÖ Swarm initialized successfully!");
                    await LoadServers();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    await JS.InvokeVoidAsync("alert", $"‚ùå Failed to initialize swarm: {error}");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"‚ùå Error: {ex.Message}");
            }
        }
    }

    private async Task DeleteServer(int id)
    {
        var server = servers?.FirstOrDefault(s => s.Id == id);
        var serverName = server?.Name ?? $"Server #{id}";
        
        if (await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete {serverName}?\n\nThis action cannot be undone."))
        {
            try
            {
                var response = await Http.DeleteAsync($"api/servers/{id}");
                
                if (response.IsSuccessStatusCode)
                {
                    await JS.InvokeVoidAsync("alert", $"‚úÖ {serverName} deleted successfully");
                    await LoadServers();
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    var statusCode = (int)response.StatusCode;
                    
                    string errorMessage;
                    if (statusCode == 404)
                    {
                        errorMessage = "Server not found. It may have already been deleted.";
                    }
                    else if (statusCode == 409)
                    {
                        errorMessage = "Cannot delete server with active applications. Please remove all applications first.";
                    }
                    else
                    {
                        errorMessage = $"Failed to delete server ({statusCode}): {errorContent}";
                    }
                    
                    await JS.InvokeVoidAsync("alert", $"‚ùå {errorMessage}");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("alert", $"‚ùå Error deleting server: {ex.Message}");
            }
        }
    }

    private string GetStatusClass(ServerStatus status)
    {
        return status switch
        {
            ServerStatus.Online => "online",
            ServerStatus.Offline => "offline",
            _ => "error"
        };
    }

    private string GetStatusIcon(ServerStatus status)
    {
        return status switch
        {
            ServerStatus.Online => "üü¢",
            ServerStatus.Offline => "üî¥",
            ServerStatus.Error => "‚ö†Ô∏è",
            _ => "üîÑ"
        };
    }

    private string GetTypeBadgeClass(ServerType type)
    {
        return type switch
        {
            ServerType.SwarmManager => "manager",
            ServerType.SwarmWorker => "worker",
            _ => "standalone"
        };
    }

    private string GetTypeIcon(ServerType type)
    {
        return type switch
        {
            ServerType.SwarmManager => "üëë",
            ServerType.SwarmWorker => "‚öôÔ∏è",
            _ => "üíª"
        };
    }

    private string GetTimeSince(DateTime date)
    {
        var span = DateTime.Now - date;
        if (span.TotalMinutes < 1) return "just now";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes}m ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours}h ago";
        return $"{(int)span.TotalDays}d ago";
    }

    private string GetNodeStateIcon(string state)
    {
        return state.ToLower() switch
        {
            "ready" => "‚úÖ",
            "down" => "üî¥",
            "disconnected" => "‚ö†Ô∏è",
            _ => "‚ö™"
        };
    }

    private string GetAvailabilityIcon(string availability)
    {string? SwarmNodeId { get; set; }
        public string? SwarmNodeState { get; set; }
        public string? SwarmNodeAvailability { get; set; }
        public 
        return availability.ToLower() switch
        {
            "active" => "‚úÖ",
            "drain" => "üîÑ",
            "pause" => "‚è∏Ô∏è",
            _ => "‚ö™"
        };
    }

    public class ServerDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Host { get; set; } = "";
        public int Port { get; set; }
        public string Username { get; set; } = "";
        public string User => Username; // Backward compatibility
        public ServerType Type { get; set; }
        public ServerStatus Status { get; set; }
        public RegionDto? Region { get; set; }
        public string? SwarmId { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime? LastSeenAt { get; set; }
        public bool IsSwarm => Type == ServerType.SwarmManager || Type == ServerType.SwarmWorker;
    }

    public class RegionDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Code { get; set; } = "";
    }
}
