@page "/servers/{id:int}"
@rendermode InteractiveServer
@using HostCraft.Core.Enums
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>@(server?.Name ?? "Server") - HostCraft</PageTitle>

<div class="server-details-page">
    <div class="page-header">
        <button class="btn-back" @onclick="GoBack">‚Üê Back to Servers</button>
        @if (server != null)
        {
            <div class="header-content">
                <div class="header-info">
                    <h1>@server.Name</h1>
                    <div class="header-badges">
                        <span class="badge badge-@GetTypeBadgeClass(server.Type)">
                            @GetTypeIcon(server.Type) @server.Type
                        </span>
                        <span class="status-badge @GetStatusClass(server.Status)">
                            @GetStatusIcon(server.Status) @server.Status
                        </span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-outline" @onclick="@(() => Navigation.NavigateTo($"/servers/{Id}/edit"))">
                        ‚úèÔ∏è Edit
                    </button>
                </div>
            </div>
        }
    </div>

    @if (loading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading server details...</p>
        </div>
    }
    else if (server == null)
    {
        <div class="error-state">
            <div class="error-icon">‚ùå</div>
            <h2>Server Not Found</h2>
            <p>The server you're looking for doesn't exist or has been removed.</p>
        </div>
    }
    else
    {
        <div class="details-container">
            <!-- Server Information Card -->
            <div class="info-card">
                <h2>Server Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">Host</span>
                        <span class="value">@server.Host:@server.Port</span>
                    </div>
                    <div class="info-item">
                        <span class="label">User</span>
                        <span class="value">@server.User</span>
                    </div>
                    @if (!string.IsNullOrEmpty(server.Region))
                    {
                        <div class="info-item">
                            <span class="label">Region</span>
                            <span class="value">@server.Region</span>
                        </div>
                    }
                    <div class="info-item">
                        <span class="label">Proxy</span>
                        <span class="value">@server.ProxyType</span>
                    </div>
                    @if (server.IsSwarm && !string.IsNullOrEmpty(server.SwarmId))
                    {
                        <div class="info-item">
                            <span class="label">Swarm ID</span>
                            <span class="value"><code>@server.SwarmId.Substring(0, 12)</code></span>
                        </div>
                    }
                    <div class="info-item">
                        <span class="label">Added</span>
                        <span class="value">@server.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                    </div>
                </div>
            </div>

            <!-- Terminal Section -->
            <div class="terminal-card">
                <div class="terminal-header">
                    <h2>üñ•Ô∏è SSH Terminal</h2>
                    <div class="terminal-controls">
                        <button class="btn btn-primary btn-sm" @onclick="OpenTerminal">
                            üñ•Ô∏è Open Full Terminal
                        </button>
                    </div>
                </div>

                <div class="terminal-container">
                    <div class="terminal-placeholder">
                        <div class="placeholder-icon">üñ•Ô∏è</div>
                        <p>Full XTerm.js-powered SSH terminal available</p>
                        <button class="btn btn-primary btn-lg" @onclick="OpenTerminal">
                            ‚ñ∂Ô∏è Open Terminal
                        </button>
                        <small>Interactive shell with full ANSI color support and command history</small>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="actions-card">
                <h2>Quick Actions</h2>
                <div class="action-buttons">
                    <button class="action-btn" @onclick="GetDockerInfo">
                        <span class="action-icon">üê≥</span>
                        <span class="action-text">Docker Info</span>
                    </button>
                    <button class="action-btn" @onclick="ViewContainers">
                        <span class="action-icon">üì¶</span>
                        <span class="action-text">Containers</span>
                    </button>
                    @if (server.IsSwarm)
                    {
                        <button class="action-btn" @onclick="ViewServices">
                            <span class="action-icon">üêù</span>
                            <span class="action-text">Services</span>
                        </button>
                    }
                    <button class="action-btn" @onclick="ViewNetworks">
                        <span class="action-icon">üåê</span>
                        <span class="action-text">Networks</span>
                    </button>
                    <button class="action-btn" @onclick="ViewImages">
                        <span class="action-icon">üñºÔ∏è</span>
                        <span class="action-text">Images</span>
                    </button>
                    <button class="action-btn" @onclick="ViewSystemLoad">
                        <span class="action-icon">üìä</span>
                        <span class="action-text">System Load</span>
                    </button>
                    <button class="action-btn" @onclick="RestartDocker">
                        <span class="action-icon">üîÑ</span>
                        <span class="action-text">Restart Docker</span>
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private ServerDto? server;
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadServer();
    }

    private async Task LoadServer()
    {
        loading = true;
        try
        {
            server = await Http.GetFromJsonAsync<ServerDto>($"api/servers/{Id}");
        }
        catch (Exception ex)
        {
            server = null;
        }
        finally
        {
            loading = false;
        }
    }

    private void OpenTerminal() => Navigation.NavigateTo($"/servers/{Id}/terminal");

    // Quick action methods
    private void GetDockerInfo() => OpenTerminal();
    private void ViewContainers() => Navigation.NavigateTo($"/servers/{Id}/containers");
    private void ViewServices() => Navigation.NavigateTo($"/servers/{Id}/services");
    private void ViewNetworks() => Navigation.NavigateTo($"/servers/{Id}/networks");
    private void ViewImages() => Navigation.NavigateTo($"/servers/{Id}/images");
    private void CheckDiskSpace() => OpenTerminal();
    private void ViewSystemLoad() => OpenTerminal();
    private void RestartDocker() => OpenTerminal();

    private void GoBack() => Navigation.NavigateTo("/servers");
    
    private string GetStatusClass(ServerStatus status) => status switch
    {
        ServerStatus.Online => "online",
        ServerStatus.Offline => "offline",
        _ => "error"
    };

    private string GetStatusIcon(ServerStatus status) => status switch
    {
        ServerStatus.Online => "üü¢",
        ServerStatus.Offline => "üî¥",
        ServerStatus.Error => "‚ö†Ô∏è",
        _ => "üîÑ"
    };

    private string GetTypeBadgeClass(ServerType type) => type switch
    {
        ServerType.SwarmManager => "manager",
        ServerType.SwarmWorker => "worker",
        _ => "standalone"
    };

    private string GetTypeIcon(ServerType type) => type switch
    {
        ServerType.SwarmManager => "üëë",
        ServerType.SwarmWorker => "‚öôÔ∏è",
        _ => "üíª"
    };

    public class ServerDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Host { get; set; } = "";
        public int Port { get; set; }
        public string User { get; set; } = "";
        public ServerType Type { get; set; }
        public ServerStatus Status { get; set; }
        public string? Region { get; set; }
        public ProxyType ProxyType { get; set; }
        public string? SwarmId { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime? LastSeenAt { get; set; }
        public bool IsSwarm => Type == ServerType.SwarmManager || Type == ServerType.SwarmWorker;
    }
}
