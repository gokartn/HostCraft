@page "/servers/{ServerId:int}/services"
@rendermode InteractiveServer
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Services - HostCraft</PageTitle>

<div class="page-container">
    <div class="page-header">
        <div class="header-left">
            <button class="btn-back" @onclick="GoBack">‚Üê Back</button>
            <h1>üêù Swarm Services</h1>
            <p class="subtitle">Manage Docker Swarm services on this server</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" @onclick="CreateService">
                ‚ûï Create Service
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading services...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            <strong>‚ùå Error:</strong> @errorMessage
        </div>
    }
    else if (services == null || !services.Any())
    {
        <div class="empty-state">
            <div class="empty-icon">üêù</div>
            <h2>No Services Running</h2>
            <p>Create a new Swarm service to get started</p>
            <button class="btn btn-primary" @onclick="CreateService">
                ‚ûï Create Service
            </button>
        </div>
    }
    else
    {
        <div class="services-grid">
            @foreach (var service in services)
            {
                <div class="service-card">
                    <div class="service-header">
                        <h3>@service.Name</h3>
                        <div class="service-actions">
                            <button class="btn-icon" @onclick="() => ViewService(service.Id)" title="View Details">
                                üëÅÔ∏è
                            </button>
                            <button class="btn-icon" @onclick="() => ViewLogs(service.Id)" title="View Logs">
                                üìÑ
                            </button>
                            <button class="btn-icon" @onclick="() => ShowScaleDialog(service)" title="Scale">
                                ‚öñÔ∏è
                            </button>
                            <button class="btn-icon btn-danger" @onclick="() => DeleteService(service.Id)" title="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    <div class="service-body">
                        <div class="service-info">
                            <div class="info-row">
                                <span class="label">Image:</span>
                                <span class="value">@service.Image</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Replicas:</span>
                                <span class="value">@service.Replicas</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Created:</span>
                                <span class="value">@service.Created.ToString("g")</span>
                            </div>
                            <div class="info-row">
                                <span class="label">ID:</span>
                                <span class="value code">@service.Id.Substring(0, 12)</span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (showScaleDialog)
{
    <div class="modal-overlay" @onclick="CloseScaleDialog">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>Scale Service</h3>
                <button class="btn-close" @onclick="CloseScaleDialog">√ó</button>
            </div>
            <div class="modal-body">
                <p>Service: <strong>@selectedService?.Name</strong></p>
                <div class="form-group">
                    <label>Number of Replicas:</label>
                    <input type="number" @bind="scaleReplicas" class="form-control" min="0" max="100" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseScaleDialog">Cancel</button>
                <button class="btn btn-primary" @onclick="ScaleService" disabled="@scaling">
                    @if (scaling)
                    {
                        <span>‚öñÔ∏è Scaling...</span>
                    }
                    else
                    {
                        <span>‚öñÔ∏è Scale</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

<style>
    .services-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: var(--space-lg);
        margin-top: var(--space-lg);
    }

    .service-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: var(--space-lg);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .service-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .service-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-md);
        padding-bottom: var(--space-md);
        border-bottom: 1px solid var(--border-color);
    }

    .service-header h3 {
        margin: 0;
        font-size: 1.25rem;
        color: var(--primary-color);
    }

    .service-actions {
        display: flex;
        gap: var(--space-sm);
    }

    .service-info .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--space-sm);
    }

    .service-info .label {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .service-info .value {
        color: var(--text-primary);
    }

    .service-info .code {
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        background: var(--bg-secondary);
        padding: 2px 6px;
        border-radius: 4px;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        max-width: 500px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-lg);
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header h3 {
        margin: 0;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: var(--text-secondary);
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-close:hover {
        color: var(--text-primary);
    }

    .modal-body {
        padding: var(--space-lg);
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-md);
        padding: var(--space-lg);
        border-top: 1px solid var(--border-color);
    }
</style>

@code {
    [Parameter]
    public int ServerId { get; set; }

    private List<ServiceDto>? services;
    private bool isLoading = true;
    private string? errorMessage;
    private bool showScaleDialog = false;
    private ServiceDto? selectedService;
    private int scaleReplicas = 1;
    private bool scaling = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadServices();
    }

    private async Task LoadServices()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            services = await Http.GetFromJsonAsync<List<ServiceDto>>($"api/servers/{ServerId}/services");
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void CreateService()
    {
        Navigation.NavigateTo($"/servers/{ServerId}/services/new");
    }

    private void ViewService(string serviceId)
    {
        Navigation.NavigateTo($"/servers/{ServerId}/services/{serviceId}");
    }

    private void ViewLogs(string serviceId)
    {
        Navigation.NavigateTo($"/servers/{ServerId}/services/{serviceId}/logs");
    }

    private void ShowScaleDialog(ServiceDto service)
    {
        selectedService = service;
        scaleReplicas = service.Replicas;
        showScaleDialog = true;
    }

    private void CloseScaleDialog()
    {
        showScaleDialog = false;
        selectedService = null;
    }

    private async Task ScaleService()
    {
        if (selectedService == null) return;

        scaling = true;
        try
        {
            var response = await Http.PostAsJsonAsync(
                $"api/servers/{ServerId}/services/{selectedService.Id}/scale",
                new { Replicas = scaleReplicas });

            if (response.IsSuccessStatusCode)
            {
                CloseScaleDialog();
                await LoadServices();
            }
            else
            {
                errorMessage = "Failed to scale service";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error scaling service: {ex.Message}";
        }
        finally
        {
            scaling = false;
        }
    }

    private async Task DeleteService(string serviceId)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this service?"))
            return;

        try
        {
            var response = await Http.DeleteAsync($"api/servers/{ServerId}/services/{serviceId}");
            if (response.IsSuccessStatusCode)
            {
                await LoadServices();
            }
            else
            {
                errorMessage = "Failed to delete service";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting service: {ex.Message}";
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo($"/servers/{ServerId}");
    }

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;

    public class ServiceDto
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Image { get; set; } = "";
        public int Replicas { get; set; }
        public DateTime Created { get; set; }
    }
}
