# Centralized configuration
x-common-variables: &common-variables
  WEB_PORT: 5000
  API_PORT: 5100

services:
  web:
    build:
      context: .
      dockerfile: src/HostCraft.Web/Dockerfile
    image: hostcraft-web:latest  # Required for swarm mode
    ports:
      - "${WEB_PORT:-5000}:8080"
    environment:
      <<: *common-variables
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      ApiUrl: http://hostcraft_api:8080
      ConnectionStrings__DefaultConnection: Host=hostcraft_postgres;Database=hostcraft;Username=hostcraft;Password=your_secure_password_here
    depends_on:
      - api
      - postgres
    restart: unless-stopped  # For standalone mode
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Access to Docker daemon
      - /proc:/host/proc:ro  # Access host processes for nsenter
      - hostcraft-data:/app/data
      - dataprotection-keys:/root/.aspnet/DataProtection-Keys  # Persist data protection keys
    cap_add:
      - SYS_ADMIN  # Required for nsenter to access host namespace
      - SYS_PTRACE  # Required for process inspection
    security_opt:
      - apparmor:unconfined  # Allow nsenter operations
    # Swarm mode configuration
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager  # Run on manager due to docker.sock access
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 10
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
        failure_action: pause
        order: stop-first
      labels:
        - "hostcraft.service=web"
        - "hostcraft.managed=true"
    networks:
      - hostcraft-network

  api:
    build:
      context: .
      dockerfile: src/HostCraft.Api/Dockerfile
    image: hostcraft-api:latest  # Required for swarm mode
    ports:
      - "${API_PORT:-5100}:8080"
    environment:
      <<: *common-variables
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__DefaultConnection: Host=postgres;Database=hostcraft;Username=hostcraft;Password=your_secure_password_here
      SKIP_LOCALHOST_SEED: "true"  # Temporarily disabled due to schema migration
      # Git Provider OAuth - set these to enable Git integrations
      GitHub__ClientId: ${GITHUB_CLIENT_ID:-}
      GitHub__ClientSecret: ${GITHUB_CLIENT_SECRET:-}
      GitLab__ClientId: ${GITLAB_CLIENT_ID:-}
      GitLab__ClientSecret: ${GITLAB_CLIENT_SECRET:-}
      Bitbucket__ClientId: ${BITBUCKET_CLIENT_ID:-}
      Bitbucket__ClientSecret: ${BITBUCKET_CLIENT_SECRET:-}
    depends_on:
      - postgres
    restart: unless-stopped  # For standalone mode
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Access to Docker daemon
      - /proc:/host/proc:ro  # Read host system metrics
      - /sys:/host/sys:ro    # Read host system info
      - dataprotection-keys:/root/.aspnet/DataProtection-Keys  # Persist data protection keys
    # Swarm mode configuration
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager  # Run on manager due to docker.sock access
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 10
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
        failure_action: pause
        order: stop-first
      labels:
        - "hostcraft.service=api"
        - "hostcraft.managed=true"
    networks:
      - hostcraft-network

  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=hostcraft
      - POSTGRES_USER=hostcraft
      - POSTGRES_PASSWORD=your_secure_password_here
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hostcraft -d hostcraft"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped  # For standalone mode
    # Swarm mode configuration
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager  # Ensure database runs on manager for data persistence
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: stop-first  # Database needs stop-first for safety
      labels:
        - "hostcraft.service=postgres"
        - "hostcraft.managed=true"
    networks:
      - hostcraft-network

volumes:
  postgres-data:
    driver: local
  hostcraft-data:
    driver: local
  dataprotection-keys:
    driver: local

networks:
  hostcraft-network:
    driver: overlay
    attachable: true
